<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flamea | Resource Locator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <style>
        /* Basic theme and font setup */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a1a1a;
            color: #f0f0f0;
        }

        /* Custom scrollbar for a better look */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #2c2c2c;
        }

        ::-webkit-scrollbar-thumb {
            background: #ff4500;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #e03e00;
        }

        /* Leaflet map container styling */
        #map {
            height: 100%;
            width: 100%;
            border-radius: 0.5rem;
            z-index: 0;
        }
        
        /* Sidebar styling */
        #sidebar-container {
            position: fixed;
            top: 0;
            left: 0;
            height: 100%;
            z-index: 1000;
            width: 250px; 
            transform: translateX(-100%);
            transition: transform 0.3s ease-in-out;
        }

        #sidebar-container.open {
            transform: translateX(0);
        }

        #content-area {
            transition: margin-left 0.3s ease-in-out;
            padding: 20px;
        }

        /* Styling for inputs and buttons to match the Flamea theme */
        .flamea-input {
            background-color: #2a2a2a;
            border: 1px solid #444;
            color: #f0f0f0;
            border-radius: 0.375rem;
            padding: 0.75rem 1rem;
            width: 100%;
        }

        .flamea-input:focus {
            outline: none;
            border-color: #ff4500;
            box-shadow: 0 0 0 2px #ff4500;
        }

        .flamea-btn {
            background-color: #ff4500;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.375rem;
            font-weight: 600;
            text-align: center;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .flamea-btn:hover {
            background-color: #e03e00;
        }
        
        .flamea-btn-secondary {
            background-color: #333;
            color: white;
        }
        
        .flamea-btn-secondary:hover {
             background-color: #444;
        }

        /* Results panel styling */
        #results-panel {
            background-color: #212121;
            padding: 1rem;
            border-radius: 0.5rem;
            overflow-y: auto;
            height: 100%;
        }

        .result-item {
            border-bottom: 1px solid #333;
            padding: 1rem 0.5rem;
            cursor: pointer;
        }
        .result-item:hover {
            background-color: #2c2c2c;
        }

        .result-item:last-child {
            border-bottom: none;
        }
        
        /* Loading spinner */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #ff4500;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

    </style>
</head>

<body class="bg-gray-900 text-white">

    <div id="sidebar-container"></div>

    <div id="content-area" class="flex flex-col h-screen p-4 lg:p-6 ml-0 lg:ml-[250px]">

        <!-- Header -->
        <header class="flex items-center justify-between pb-4">
            <div class="flex items-center gap-4">
                 <button id="menu-toggle" class="lg:hidden text-white">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                </button>
                <h1 class="text-2xl md:text-3xl font-bold text-orange-500">Resource Locator</h1>
            </div>
            <p class="text-sm text-gray-400">Find courts, services, and support near you.</p>
        </header>

        <!-- Main Content -->
        <main class="flex-grow grid grid-cols-1 lg:grid-cols-3 gap-4 lg:gap-6 overflow-hidden">
            
            <!-- Left Panel: Controls and Results -->
            <div class="flex flex-col gap-4 lg:gap-6 h-full overflow-y-auto">
                
                <!-- Search Controls -->
                <div class="bg-gray-800 p-4 rounded-lg shadow-lg">
                    <h2 class="text-xl font-semibold mb-4 text-white">Search Options</h2>
                    <div class="space-y-4">
                        <!-- UPDATED: More intuitive address form -->
                        <div id="manual-address-form" class="space-y-3">
                            <div>
                                <label for="street-address" class="block text-sm font-medium text-gray-300 mb-1">Street Address</label>
                                <input type="text" id="street-address" class="flamea-input" placeholder="e.g., 123 Main Street">
                            </div>
                            <div>
                                <label for="town-suburb" class="block text-sm font-medium text-gray-300 mb-1">Town / Suburb</label>
                                <input type="text" id="town-suburb" class="flamea-input" placeholder="e.g., Soweto">
                            </div>
                            <div>
                                <label for="city" class="block text-sm font-medium text-gray-300 mb-1">City</label>
                                <input type="text" id="city" class="flamea-input" placeholder="e.g., Johannesburg">
                            </div>
                        </div>
                        <div class="flex flex-col sm:flex-row gap-2">
                             <button id="search-manual" class="flamea-btn w-full">Search Manually</button>
                             <button id="search-auto" class="flamea-btn flamea-btn-secondary w-full">Find Near Me</button>
                        </div>
                    </div>
                </div>

                <!-- Filters -->
                <div class="bg-gray-800 p-4 rounded-lg shadow-lg">
                    <h2 class="text-xl font-semibold mb-4 text-white">Filter Results</h2>
                    <div class="space-y-2">
                         <div>
                            <label for="radius" class="block text-sm font-medium text-gray-300">Search Radius: <span id="radius-value">20</span> km</label>
                            <input type="range" id="radius" min="5" max="200" value="20" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-orange-500">
                        </div>
                        <div>
                            <label for="filter-type" class="block text-sm font-medium text-gray-300">Resource Type</label>
                            <select id="filter-type" class="flamea-input mt-1">
                                <option value="All">All Resources</option>
                                <option value="Lower Court">Lower Courts</option>
                                <option value="Higher & Special Court">Higher & Special Courts</option>
                                <option value="Government Service">Government Services</option>
                                <option value="NGO">NGOs / Support</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Results Panel -->
                <div id="results-container" class="bg-gray-800 p-4 rounded-lg shadow-lg flex-grow overflow-hidden flex flex-col">
                    <h2 class="text-xl font-semibold mb-2 text-white">Results</h2>
                     <div id="results-panel" class="flex-grow">
                       <p id="results-placeholder" class="text-gray-400 text-center mt-8">Enter an address or use "Find Near Me" to see results.</p>
                       <div id="loader" class="loader hidden"></div>
                    </div>
                </div>

            </div>

            <!-- Right Panel: Map -->
            <div class="lg:col-span-2 h-full min-h-[400px] lg:min-h-0 bg-gray-800 rounded-lg shadow-lg p-2">
                <div id="map"></div>
            </div>

        </main>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <script>
        // --- START: master-locator-db.js CONTENT ---
        // FIXED: Changed 'const' to 'window.' to make variables globally accessible to other scripts.
        console.log("Master locator database loading...");

        window.higherSpecialCourts = [
            { "name": "Constitutional Court of South Africa", "province": "Gauteng", "city": "Johannesburg", "address": "1 Hospital Street, Constitution Hill, Braamfontein, Johannesburg, 2017", "lat": -26.1923, "lng": 28.0436, "phone": "011 359 7400", "type": "Higher & Special Court" },
            { "name": "Supreme Court of Appeal", "province": "Free State", "city": "Bloemfontein", "address": "Cnr Elizabeth & President Brand Streets, Bloemfontein, 9301", "lat": -29.1160, "lng": 26.2168, "phone": "051 412 7400", "type": "Higher & Special Court" },
        ];

        window.lowerCourts = [
            { "name": "Johannesburg Magistrate's Court", "province": "Gauteng", "city": "Johannesburg", "address": "Cnr Ntemi Piliso & Fox Streets, Ferreirasdorp, Johannesburg, 2001", "lat": -26.2064, "lng": 28.0326, "phone": "011 491 5000", "type": "Lower Court" },
            { "name": "Cape Town Magistrate's Court", "province": "Western Cape", "city": "Cape Town", "address": "22 Caledon Street, Cape Town City Centre, Cape Town, 8001", "lat": -33.9288, "lng": 18.4241, "phone": "021 469 5111", "type": "Lower Court" },
            { "name": "Durban Magistrate's Court", "province": "KwaZulu-Natal", "city": "Durban", "address": "Somtseu Road, Durban Central, Durban, 4001", "lat": -29.8516, "lng": 31.0264, "phone": "031 302 4111", "type": "Lower Court" },
            { "name": "Pretoria Magistrate's Court", "province": "Gauteng", "city": "Pretoria", "address": "216 Visagie Street, Pretoria Central, Pretoria, 0002", "lat": -25.7483, "lng": 28.1881, "phone": "012 319 4000", "type": "Lower Court" },
            { "name": "Gqeberha Magistrate's Court", "province": "Eastern Cape", "city": "Gqeberha", "address": "North End, Gqeberha, 6001", "lat": -33.9452, "lng": 25.6025, "phone": "041 502 5111", "type": "Lower Court" },
        ];

        window.governmentServices = [
            { "name": "Home Affairs: Harrison Street", "province": "Gauteng", "city": "Johannesburg", "address": "77 Harrison St, Johannesburg, 2001", "lat": -26.2044, "lng": 28.0387, "phone": "0800 601 190", "type": "Government Service" },
            { "name": "SAPS Johannesburg Central", "province": "Gauteng", "city": "Johannesburg", "address": "1 Commissioner St, Ferreirasdorp, Johannesburg, 2048", "lat": -26.2069, "lng": 28.0355, "phone": "011 497 7000", "type": "Government Service" },
            { "name": "Master of the High Court, Pretoria", "province": "Gauteng", "city": "Pretoria", "address": "255 Thabo Sehume St, Pretoria Central, Pretoria, 0002", "lat": -25.7479, "lng": 28.1891, "phone": "012 315 1202", "type": "Government Service" }
        ];

        window.ngos = [
            { "name": "Legal Aid South Africa - Johannesburg", "province": "Gauteng", "city": "Johannesburg", "address": "Gauteng Provincial Office, 29th Floor, Carlton Centre, 150 Commissioner Street, Johannesburg", "lat": -26.2059, "lng": 28.0469, "phone": "011 870 1480", "type": "NGO" },
            { "name": "Lawyers for Human Rights - Johannesburg", "province": "Gauteng", "city": "Johannesburg", "address": "4th Floor, West Wing, South Point Central, 80 Jorissen Street, Braamfontein, Johannesburg", "lat": -26.1951, "lng": 28.0396, "phone": "011 339 1960", "type": "NGO" }
        ];
        // --- END: master-locator-db.js CONTENT ---
    </script>
    
    <script>
        // --- START: locator.js CONTENT ---
        document.addEventListener('DOMContentLoaded', () => {
            console.log("Starting data load...");

            let allData = [];
            const dataSources = [
                { type: 'Lower Court', data: window.lowerCourts },
                { type: 'Higher & Special Court', data: window.higherSpecialCourts },
                { type: 'NGO', data: window.ngos },
                { type: 'Government Service', data: window.governmentServices },
            ];

            dataSources.forEach(source => {
                if (source.data && Array.isArray(source.data)) {
                    allData = allData.concat(source.data);
                } else {
                    console.warn(`Data source for type '${source.type}' is missing or not an array.`);
                }
            });

            console.log(`Data loading complete. Total records: ${allData.length}`);

            const map = L.map('map').setView([-28.8, 24.5], 5);
            let userMarker = null;
            let resultMarkers = L.layerGroup().addTo(map);

            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                subdomains: 'abcd',
                maxZoom: 20
            }).addTo(map);

            const searchManualBtn = document.getElementById('search-manual');
            const searchAutoBtn = document.getElementById('search-auto');
            const radiusSlider = document.getElementById('radius');
            const radiusValueSpan = document.getElementById('radius-value');
            const filterTypeSelect = document.getElementById('filter-type');
            const resultsPanel = document.getElementById('results-panel');
            const resultsPlaceholder = document.getElementById('results-placeholder');
            const loader = document.getElementById('loader');

            const updateRadiusValue = () => {
                radiusValueSpan.textContent = radiusSlider.value;
            };
            radiusSlider.addEventListener('input', updateRadiusValue);

            const showLoader = (show) => {
                loader.classList.toggle('hidden', !show);
                resultsPlaceholder.classList.toggle('hidden', show);
            };

            // NEW: Function to display non-blocking messages to the user
            const displayMessage = (message, type = 'info') => {
                const colorClass = type === 'error' ? 'text-red-400' : (type === 'warning' ? 'text-yellow-400' : 'text-gray-400');
                resultsPanel.innerHTML = `<p class="${colorClass} text-center mt-8">${message}</p>`;
            };
            
            const performSearch = () => {
                 if(userMarker) {
                    findNearby(userMarker.getLatLng());
                 } else {
                    displayMessage("Please set a location first using manual or automatic search.", "warning");
                 }
            };
            
            radiusSlider.addEventListener('change', performSearch);
            filterTypeSelect.addEventListener('change', performSearch);

            // UPDATED: Gathers input from multiple fields for a more accurate search
            const searchByAddress = async () => {
                const street = document.getElementById('street-address').value;
                const town = document.getElementById('town-suburb').value;
                const city = document.getElementById('city').value;

                const addressParts = [street, town, city].filter(part => part.trim() !== '');
                
                if (addressParts.length === 0) {
                    displayMessage("Please enter at least one part of the address.", "warning");
                    return;
                }
                const address = addressParts.join(', ');

                showLoader(true);
                resultsPanel.innerHTML = '';
                
                try {
                    const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&countrycodes=za&limit=1`);
                    const data = await response.json();

                    if (data && data.length > 0) {
                        const location = data[0];
                        const latLng = L.latLng(location.lat, location.lon);
                        updateUserMarker(latLng, `Your searched location: ${location.display_name}`);
                        map.setView(latLng, 12);
                        findNearby(latLng);
                    } else {
                        displayMessage("Could not find that location. Please try being more specific.", "error");
                        showLoader(false);
                    }
                } catch (error) {
                    console.error("Error geocoding address:", error);
                    displayMessage("An error occurred while searching. Please check your connection.", "error");
                    showLoader(false);
                }
            };
            
            searchManualBtn.addEventListener('click', searchByAddress);

            const searchByGeolocation = () => {
                if (!navigator.geolocation) {
                    displayMessage("Geolocation is not supported by your browser.", "warning");
                    return;
                }
                showLoader(true);
                resultsPanel.innerHTML = '';
                
                navigator.geolocation.getCurrentPosition(position => {
                    const latLng = L.latLng(position.coords.latitude, position.coords.longitude);
                    updateUserMarker(latLng, "Your current location");
                    map.setView(latLng, 12);
                    findNearby(latLng);
                }, () => {
                    displayMessage("Unable to retrieve your location. Please enable location services.", "error");
                    showLoader(false);
                });
            };

            searchAutoBtn.addEventListener('click', searchByGeolocation);

            const updateUserMarker = (latLng, popupText) => {
                if (userMarker) {
                    userMarker.setLatLng(latLng).setPopupContent(popupText);
                } else {
                    userMarker = L.marker(latLng, {
                        icon: L.icon({
                            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
                            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                            iconSize: [25, 41],
                            iconAnchor: [12, 41],
                            popupAnchor: [1, -34],
                            shadowSize: [41, 41]
                        })
                    }).addTo(map);
                }
                 userMarker.bindPopup(popupText).openPopup();
            };

            const findNearby = (centerLatLng) => {
                showLoader(true);
                resultsPanel.innerHTML = ''; 
                resultMarkers.clearLayers();

                const radius = parseFloat(radiusSlider.value) * 1000;
                const filterType = filterTypeSelect.value;
                
                setTimeout(() => {
                    const filteredData = allData.filter(item => {
                        if (!item.lat || !item.lng) return false;
                        const itemLatLng = L.latLng(item.lat, item.lng);
                        const distance = centerLatLng.distanceTo(itemLatLng);
                        const typeMatch = (filterType === 'All') || (item.type === filterType);
                        return distance <= radius && typeMatch;
                    });
    
                    filteredData.forEach(item => {
                        const itemLatLng = L.latLng(item.lat, item.lng);
                        item.distance = centerLatLng.distanceTo(itemLatLng) / 1000;
                    });
                    filteredData.sort((a, b) => a.distance - b.distance);
    
                    displayResults(filteredData);
                    showLoader(false);
                }, 50);

            };

            const displayResults = (results) => {
                resultsPanel.innerHTML = '';
                
                if (results.length === 0) {
                     displayMessage("No results found. Try expanding your search radius or changing the filter.", "info");
                     return;
                }

                results.forEach(item => {
                    const resultEl = document.createElement('div');
                    resultEl.className = 'result-item';
                    resultEl.innerHTML = `
                        <h3 class="font-bold text-orange-500">${item.name}</h3>
                        <p class="text-sm text-gray-300">${item.address}</p>
                        <p class="text-xs text-gray-500">${item.type} - Approx. ${item.distance.toFixed(1)} km away</p>
                        ${item.phone ? `<a href="tel:${item.phone}" class="text-sm text-blue-400 hover:underline">${item.phone}</a>` : ''}
                    `;
                    resultsPanel.appendChild(resultEl);
                    
                    const marker = L.marker([item.lat, item.lng], {
                         icon: L.icon({
                            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                            iconSize: [25, 41],
                            iconAnchor: [12, 41],
                            popupAnchor: [1, -34],
                            shadowSize: [41, 41]
                        })
                    }).addTo(resultMarkers);

                    marker.bindPopup(`<b>${item.name}</b><br>${item.address}`);
                    resultEl.addEventListener('click', () => {
                        map.setView([item.lat, item.lng], 15);
                        marker.openPopup();
                    });
                });
            };
        });
        // --- END: locator.js CONTENT ---
    </script>
    <script>
        // --- START: sidebar-loader.js CONTENT ---
        document.addEventListener('DOMContentLoaded', function () {
            const sidebarContainer = document.getElementById('sidebar-container');
            const contentArea = document.getElementById('content-area');
            const menuToggle = document.getElementById('menu-toggle');

            fetch('sidebar.html')
                .then(response => response.ok ? response.text() : Promise.reject('Sidebar not found'))
                .then(data => {
                    sidebarContainer.innerHTML = data;
                    console.log("Sidebar loaded successfully.");
                    setupSidebar();
                })
                .catch(error => {
                    console.error('Error loading sidebar:', error);
                    sidebarContainer.innerHTML = '<p class="p-4 text-red-400">Error loading sidebar.</p>';
                });

            function setupSidebar() {
                const isMobile = () => window.innerWidth < 1024;
                const updateLayout = () => {
                    if (isMobile()) {
                        sidebarContainer.classList.remove('open');
                        contentArea.style.marginLeft = '0';
                    } else {
                        sidebarContainer.classList.add('open');
                        contentArea.style.marginLeft = sidebarContainer.offsetWidth + 'px';
                    }
                };

                menuToggle.addEventListener('click', () => {
                    sidebarContainer.classList.toggle('open');
                });
                
                window.addEventListener('resize', updateLayout);
                updateLayout(); // Initial check
            }
        });
        // --- END: sidebar-loader.js CONTENT ---
    </script>
</body>

</html>

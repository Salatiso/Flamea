<!DOCTYPE html>
<html lang="en" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flamea | Resource Locator</title>
    <!-- Leaflet CSS for the interactive map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <!-- Main Flamea Stylesheet -->
    <link rel="stylesheet" href="assets/css/style.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Slab:wght@700&family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Page-specific styles for map and results panel */
        body {
            font-family: 'Open Sans', sans-serif;
        }

        #map {
            height: 100%;
            width: 100%;
            border-radius: 0.75rem; /* Increased rounding */
            z-index: 0;
        }

        #results-panel {
            background-color: rgba(30, 41, 59, 0.7); /* slate-800 with transparency */
            backdrop-filter: blur(4px);
            overflow-y: auto;
            height: 100%;
        }

        .result-item {
            border-bottom: 1px solid #475569; /* slate-600 */
            padding: 1rem 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .result-item:hover {
            background-color: rgba(51, 65, 85, 0.7); /* slate-700 with transparency */
        }

        .result-item:last-child {
            border-bottom: none;
        }

        .loader {
            border: 4px solid #475569; /* slate-600 */
            border-top: 4px solid #fb923c; /* orange-400 */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 40px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>

<body class="bg-gray-900 text-gray-200">

    <div class="main-container">
        <!-- Sidebar will be loaded here by main.js -->
        <div id="sidebar-placeholder"></div>

        <!-- This main-content div will get the dynamic background from main.js -->
        <main class="main-content p-4 md:p-8">
            
            <!-- This container constrains the width and centers the content -->
            <div class="max-w-7xl mx-auto h-full flex flex-col">
                
                <!-- Header -->
                <header class="text-center mb-8 bg-gray-800/50 backdrop-blur-sm p-6 rounded-lg">
                    <h1 class="text-4xl md:text-5xl font-bold font-roboto-slab text-white">Resource Locator</h1>
                    <p class="text-lg text-gray-300 mt-2">Find courts, government services, and father-friendly support near you.</p>
                </header>

                <!-- Main Content Grid -->
                <div class="flex-grow grid grid-cols-1 lg:grid-cols-3 gap-6 overflow-hidden">
                    
                    <!-- Left Panel: Controls and Results -->
                    <div class="flex flex-col gap-6 h-full min-h-[500px] lg:min-h-0 overflow-y-auto">
                        
                        <!-- Search Controls -->
                        <div class="bg-gray-800/70 backdrop-blur-sm p-6 rounded-xl shadow-lg border border-gray-700">
                            <h2 class="text-xl font-semibold mb-4 text-white">1. Set Your Location</h2>
                            <div class="space-y-4">
                                <div id="manual-address-form" class="space-y-3">
                                    <input type="text" id="street-address" class="form-input" placeholder="Street Address (Optional)">
                                    <input type="text" id="town-suburb" class="form-input" placeholder="Town / Suburb">
                                    <input type="text" id="city" class="form-input" placeholder="City">
                                </div>
                                <div class="flex flex-col sm:flex-row gap-4">
                                     <button id="search-manual" class="btn btn-primary w-full">Search Address</button>
                                     <button id="search-auto" class="btn btn-secondary w-full">Find Near Me</button>
                                </div>
                            </div>
                        </div>

                        <!-- Filters -->
                        <div class="bg-gray-800/70 backdrop-blur-sm p-6 rounded-xl shadow-lg border border-gray-700">
                            <h2 class="text-xl font-semibold mb-4 text-white">2. Filter Results</h2>
                            <div class="space-y-4">
                                 <div>
                                    <label for="radius" class="block text-sm font-medium text-gray-300">Search Radius: <span id="radius-value" class="font-bold text-orange-400">20</span> km</label>
                                    <input type="range" id="radius" min="5" max="200" value="20" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-orange-400">
                                </div>
                                <div>
                                    <label for="filter-type" class="block text-sm font-medium text-gray-300">Resource Type</label>
                                    <select id="filter-type" class="form-select mt-1">
                                        <option value="All">All Resources</option>
                                        <option value="Lower Court">Lower Courts</option>
                                        <option value="Higher & Special Court">Higher & Special Courts</option>
                                        <option value="Government Service">Government Services</option>
                                        <option value="NGO">NGOs / Support</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Results Panel -->
                        <div id="results-container" class="bg-gray-800/70 backdrop-blur-sm border border-gray-700 p-4 rounded-xl shadow-lg flex-grow overflow-hidden flex flex-col">
                            <h2 class="text-xl font-semibold mb-2 text-white">3. Results</h2>
                             <div id="results-panel" class="flex-grow rounded-lg">
                               <p id="results-placeholder" class="text-gray-400 text-center mt-8 px-4">Enter an address or use "Find Near Me" to see results.</p>
                               <div id="loader" class="loader hidden"></div>
                            </div>
                        </div>

                    </div>

                    <!-- Right Panel: Map -->
                    <div class="lg:col-span-2 h-full min-h-[400px] lg:min-h-[600px] bg-gray-800/50 rounded-xl shadow-lg p-2 border border-gray-700">
                        <div id="map"></div>
                    </div>

                </div>
            </div>
        </main>
    </div>

    <!-- Leaflet JS for the interactive map -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <!-- Unified site script for sidebar, background, etc. -->
    <script type="module" src="assets/js/main.js"></script>

    <!-- Locator-specific functionality -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Check if we are on the locator page by looking for the map element
            if (!document.getElementById('map')) {
                return;
            }

            // --- Database ---
            const higherSpecialCourts = [
                { "name": "Constitutional Court of South Africa", "province": "Gauteng", "city": "Johannesburg", "address": "1 Hospital Street, Constitution Hill, Braamfontein, Johannesburg, 2017", "lat": -26.1923, "lng": 28.0436, "phone": "011 359 7400", "type": "Higher & Special Court" },
                { "name": "Supreme Court of Appeal", "province": "Free State", "city": "Bloemfontein", "address": "Cnr Elizabeth & President Brand Streets, Bloemfontein, 9301", "lat": -29.1160, "lng": 26.2168, "phone": "051 412 7400", "type": "Higher & Special Court" },
            ];
            const lowerCourts = [
                { "name": "Johannesburg Magistrate's Court", "province": "Gauteng", "city": "Johannesburg", "address": "Cnr Ntemi Piliso & Fox Streets, Ferreirasdorp, Johannesburg, 2001", "lat": -26.2064, "lng": 28.0326, "phone": "011 491 5000", "type": "Lower Court" },
                { "name": "Cape Town Magistrate's Court", "province": "Western Cape", "city": "Cape Town", "address": "22 Caledon Street, Cape Town City Centre, Cape Town, 8001", "lat": -33.9288, "lng": 18.4241, "phone": "021 469 5111", "type": "Lower Court" },
                { "name": "Durban Magistrate's Court", "province": "KwaZulu-Natal", "city": "Durban", "address": "Somtseu Road, Durban Central, Durban, 4001", "lat": -29.8516, "lng": 31.0264, "phone": "031 302 4111", "type": "Lower Court" },
                { "name": "Pretoria Magistrate's Court", "province": "Gauteng", "city": "Pretoria", "address": "216 Visagie Street, Pretoria Central, Pretoria, 0002", "lat": -25.7483, "lng": 28.1881, "phone": "012 319 4000", "type": "Lower Court" },
                { "name": "Gqeberha Magistrate's Court", "province": "Eastern Cape", "city": "Gqeberha", "address": "North End, Gqeberha, 6001", "lat": -33.9452, "lng": 25.6025, "phone": "041 502 5111", "type": "Lower Court" },
            ];
            const governmentServices = [
                { "name": "Home Affairs: Harrison Street", "province": "Gauteng", "city": "Johannesburg", "address": "77 Harrison St, Johannesburg, 2001", "lat": -26.2044, "lng": 28.0387, "phone": "0800 601 190", "type": "Government Service" },
                { "name": "SAPS Johannesburg Central", "province": "Gauteng", "city": "Johannesburg", "address": "1 Commissioner St, Ferreirasdorp, Johannesburg, 2048", "lat": -26.2069, "lng": 28.0355, "phone": "011 497 7000", "type": "Government Service" },
                { "name": "Master of the High Court, Pretoria", "province": "Gauteng", "city": "Pretoria", "address": "255 Thabo Sehume St, Pretoria Central, Pretoria, 0002", "lat": -25.7479, "lng": 28.1891, "phone": "012 315 1202", "type": "Government Service" }
            ];
            const ngos = [
                { "name": "Legal Aid South Africa - Johannesburg", "province": "Gauteng", "city": "Johannesburg", "address": "Gauteng Provincial Office, 29th Floor, Carlton Centre, 150 Commissioner Street, Johannesburg", "lat": -26.2059, "lng": 28.0469, "phone": "011 870 1480", "type": "NGO" },
                { "name": "Lawyers for Human Rights - Johannesburg", "province": "Gauteng", "city": "Johannesburg", "address": "4th Floor, West Wing, South Point Central, 80 Jorissen Street, Braamfontein, Johannesburg", "lat": -26.1951, "lng": 28.0396, "phone": "011 339 1960", "type": "NGO" }
            ];
            const allData = [...higherSpecialCourts, ...lowerCourts, ...governmentServices, ...ngos];

            // --- Map and UI Elements ---
            const map = L.map('map').setView([-28.8, 24.5], 5);
            let userMarker = null;
            let resultMarkers = L.layerGroup().addTo(map);

            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                subdomains: 'abcd',
                maxZoom: 20
            }).addTo(map);

            const searchManualBtn = document.getElementById('search-manual');
            const searchAutoBtn = document.getElementById('search-auto');
            const radiusSlider = document.getElementById('radius');
            const radiusValueSpan = document.getElementById('radius-value');
            const filterTypeSelect = document.getElementById('filter-type');
            const resultsPanel = document.getElementById('results-panel');
            const loader = document.getElementById('loader');

            const updateUserMarker = (latLng, popupText) => {
                const userIcon = L.icon({
                    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
                    shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                    iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
                });
                if (userMarker) {
                    userMarker.setLatLng(latLng).setPopupContent(popupText);
                } else {
                    userMarker = L.marker(latLng, { icon: userIcon }).addTo(map);
                }
                userMarker.bindPopup(popupText).openPopup();
            };

            const displayMessage = (message, type = 'info') => {
                const colorClass = type === 'error' ? 'text-red-400' : 'text-gray-400';
                resultsPanel.innerHTML = `<p class="${colorClass} text-center mt-8 px-4">${message}</p>`;
            };

            const findNearby = (centerLatLng) => {
                loader.classList.remove('hidden');
                resultsPanel.innerHTML = ''; 
                resultMarkers.clearLayers();

                const radius = parseFloat(radiusSlider.value) * 1000;
                const filterType = filterTypeSelect.value;
                
                setTimeout(() => {
                    const filteredData = allData.filter(item => {
                        if (!item.lat || !item.lng) return false;
                        const itemLatLng = L.latLng(item.lat, item.lng);
                        const distance = centerLatLng.distanceTo(itemLatLng);
                        const typeMatch = (filterType === 'All') || (item.type === filterType);
                        return distance <= radius && typeMatch;
                    });
    
                    filteredData.forEach(item => {
                        const itemLatLng = L.latLng(item.lat, item.lng);
                        item.distance = centerLatLng.distanceTo(itemLatLng) / 1000;
                    });
                    filteredData.sort((a, b) => a.distance - b.distance);
    
                    displayResults(filteredData);
                    loader.classList.add('hidden');
                }, 100); // Small delay to allow UI to update
            };
            
            const displayResults = (results) => {
                resultsPanel.innerHTML = '';
                if (results.length === 0) {
                     displayMessage("No results found. Try expanding the search radius.", "info");
                     return;
                }

                results.forEach(item => {
                    const resultEl = document.createElement('div');
                    resultEl.className = 'result-item';
                    resultEl.innerHTML = `
                        <h3 class="font-bold text-orange-400">${item.name}</h3>
                        <p class="text-sm text-gray-300">${item.address}</p>
                        <p class="text-xs text-gray-500">${item.type} - Approx. ${item.distance.toFixed(1)} km away</p>
                        ${item.phone ? `<a href="tel:${item.phone}" class="text-sm text-blue-400 hover:underline">${item.phone}</a>` : ''}
                    `;
                    resultsPanel.appendChild(resultEl);
                    
                    const marker = L.marker([item.lat, item.lng]).addTo(resultMarkers);
                    marker.bindPopup(`<b>${item.name}</b><br>${item.address}`);
                    resultEl.addEventListener('click', () => {
                        map.setView([item.lat, item.lng], 15);
                        marker.openPopup();
                    });
                });
            };

            const searchByAddress = async () => {
                const street = document.getElementById('street-address').value;
                const town = document.getElementById('town-suburb').value;
                const city = document.getElementById('city').value;
                const addressParts = [street, town, city].filter(part => part.trim() !== '');
                if (addressParts.length === 0) {
                    displayMessage("Please enter an address to search.", "warning");
                    return;
                }
                const address = addressParts.join(', ');

                loader.classList.remove('hidden');
                resultsPanel.innerHTML = '';
                
                try {
                    const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&countrycodes=za&limit=1`);
                    const data = await response.json();
                    if (data && data.length > 0) {
                        const location = data[0];
                        const latLng = L.latLng(location.lat, location.lon);
                        updateUserMarker(latLng, `Searched: ${location.display_name.split(',').slice(0,3).join(',')}`);
                        map.setView(latLng, 12);
                        findNearby(latLng);
                    } else {
                        displayMessage("Could not find that location. Please be more specific.", "error");
                        loader.classList.add('hidden');
                    }
                } catch (error) {
                    console.error("Geocoding error:", error);
                    displayMessage("An error occurred while searching.", "error");
                    loader.classList.add('hidden');
                }
            };

            const searchByGeolocation = () => {
                if (!navigator.geolocation) {
                    displayMessage("Geolocation is not supported by your browser.", "warning");
                    return;
                }
                loader.classList.remove('hidden');
                resultsPanel.innerHTML = '';
                navigator.geolocation.getCurrentPosition(position => {
                    const latLng = L.latLng(position.coords.latitude, position.coords.longitude);
                    updateUserMarker(latLng, "Your current location");
                    map.setView(latLng, 12);
                    findNearby(latLng);
                }, () => {
                    displayMessage("Could not get your location. Please enable location services.", "error");
                    loader.classList.add('hidden');
                });
            };

            // Event Listeners
            radiusSlider.addEventListener('input', () => { radiusValueSpan.textContent = radiusSlider.value; });
            radiusSlider.addEventListener('change', () => { if(userMarker) findNearby(userMarker.getLatLng()); });
            filterTypeSelect.addEventListener('change', () => { if(userMarker) findNearby(userMarker.getLatLng()); });
            searchManualBtn.addEventListener('click', searchByAddress);
            searchAutoBtn.addEventListener('click', searchByGeolocation);
        });
    </script>

</body>
</html>

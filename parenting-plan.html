<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parenting Plan - Flamea</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(to bottom, #1f2937, #111827);
            min-height: 100vh;
        }
        .sidebar {
            background: #111827;
            border-right: 1px solid #1f2937;
        }
        .sidebar a {
            @apply block px-4 py-2 text-gray-300 hover:bg-gray-700 hover:text-white;
        }
        .hidden {
            display: none;
        }
        input, select, textarea {
            @apply bg-gray-700 text-white p-2 rounded w-full mb-2 border border-gray-600;
        }
        button {
            @apply rounded transition;
        }
        .step {
            @apply bg-gray-800 p-6 rounded-lg shadow-md;
        }
        .slider {
            @apply w-full h-2 bg-gray-600 rounded-full appearance-none;
        }
        .slider::-webkit-slider-thumb {
            @apply w-4 h-4 bg-blue-600 rounded-full cursor-pointer;
        }
    </style>
</head>
<body class="text-white">
    <div class="flex min-h-screen">
        <!-- Sidebar -->
        <aside class="sidebar w-64 p-4 fixed h-full">
            <h2 class="text-xl font-bold mb-4">Flamea</h2>
            <nav>
                <a href="/about.html">About</a>
                <a href="/training.html">Training</a>
                <a href="/parenting-plan.html" class="bg-gray-700 text-white">Parenting Plan</a>
            </nav>
        </aside>
        <main class="flex-1 p-8 ml-64">
            <header class="mb-8">
                <h1 class="text-3xl font-bold">The Co-Parenting Compass</h1>
                <p class="text-gray-400">Navigate your parenting journey with clarity and confidence.</p>
            </header>

            <!-- Hub Section -->
            <div id="hub" class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="hub-card bg-gray-800 p-6 rounded-lg shadow-md cursor-pointer hover:bg-gray-700 transition" data-section="wizard">
                    <h2 class="text-xl font-semibold">Automated Wizard</h2>
                    <p class="text-gray-300">Start here. Let us guide you.</p>
                </div>
                <div class="hub-card bg-gray-800 p-6 rounded-lg shadow-md cursor-pointer hover:bg-gray-700 transition" data-section="builder">
                    <h2 class="text-xl font-semibold">Manual Builder</h2>
                    <p class="text-gray-300">Go straight to the full plan.</p>
                </div>
                <div class="hub-card bg-gray-800 p-6 rounded-lg shadow-md cursor-pointer hover:bg-gray-700 transition" data-section="featured">
                    <h2 class="text-xl font-semibold">Featured Forms</h2>
                    <p class="text-gray-300">Access templates like Affidavits or School Letters.</p>
                </div>
            </div>

            <!-- Wizard Modal -->
            <div id="wizard-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
                <div class="bg-gray-800 p-8 rounded-lg w-full max-w-lg">
                    <h2 class="text-2xl font-bold mb-4">Automated Wizard</h2>
                    <div id="wizard-step-1" class="space-y-4">
                        <p class="text-gray-300">Step 1: Select your goal</p>
                        <label class="flex items-center">
                            <input type="radio" name="goal" value="simulation" class="mr-2" checked> Simulation/Practice
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="goal" value="actual" class="mr-2"> Actual Document
                        </label>
                        <button id="wizard-next-1" class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4">Next</button>
                    </div>
                    <div id="wizard-step-2" class="hidden space-y-4">
                        <p class="text-gray-300">Step 2: Select sections</p>
                        <label class="flex items-center">
                            <input type="checkbox" name="sections" value="parties" checked class="mr-2"> Parties & Children
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" name="sections" value="schedule" checked class="mr-2"> Custody & Activity Schedule
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" name="sections" value="finances" checked class="mr-2"> Expense & Benefit Tracker
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" name="sections" value="communication" checked class="mr-2"> Communication Plan
                        </label>
                        <button id="begin-builder" class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4">Begin</button>
                    </div>
                </div>
            </div>

            <!-- Builder Container -->
            <div id="builder" class="hidden space-y-6">
                <div id="step-navigation" class="flex justify-between mb-4">
                    <button id="prev-step" class="bg-gray-600 hover:bg-gray-700 text-white py-2 px-4 disabled:opacity-50" disabled>Previous</button>
                    <button id="next-step" class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4">Next</button>
                </div>
                <div id="step-parties" class="step hidden">
                    <h2 class="text-2xl font-bold mb-4">Parties & Children</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h3 class="text-lg font-semibold mb-2">Parent A</h3>
                            <div id="parent-a-list" class="space-y-4"></div>
                            <button class="add-parent-a bg-blue-600 hover:bg-blue-700 text-white py-1 px-2 mt-2">Add Parent A</button>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold mb-2">Parent B</h3>
                            <div id="parent-b-list" class="space-y-4"></div>
                            <button class="add-parent-b bg-blue-600 hover:bg-blue-700 text-white py-1 px-2 mt-2">Add Parent B</button>
                        </div>
                    </div>
                    <div class="mt-6">
                        <h3 class="text-lg font-semibold mb-2">Children</h3>
                        <div id="children-list" class="space-y-4"></div>
                        <button class="add-child bg-blue-600 hover:bg-blue-700 text-white py-1 px-2 mt-2">Add Child</button>
                    </div>
                    <button class="print-section bg-green-600 hover:bg-green-700 text-white py-2 px-4 mt-4"><i class="fas fa-print mr-2"></i>Print/Send Section</button>
                </div>
                <div id="step-schedule" class="step hidden">
                    <h2 class="text-2xl font-bold mb-4">Custody & Activity Schedule</h2>
                    <div id="time-dashboard" class="bg-gray-800 p-4 rounded-lg mb-4">
                        <h3 class="text-lg font-semibold">Time Dashboard</h3>
                        <div id="time-stats" class="text-gray-300"></div>
                    </div>
                    <div class="space-y-4">
                        <label class="block">Who has custody?
                            <select id="custody-holder" class="mt-1">
                                <option value="">Select</option>
                                <option value="parent-a">Parent A</option>
                                <option value="parent-b">Parent B</option>
                                <option value="other">Other</option>
                            </select>
                        </label>
                        <div id="custody-other" class="hidden space-y-2">
                            <input type="text" id="custody-other-name" placeholder="Name">
                            <input type="text" id="custody-other-relationship" placeholder="Relationship to Child">
                        </div>
                        <label class="block">How was this decided?
                            <select id="custody-decision" class="mt-1">
                                <option value="mutual">Mutual Agreement</option>
                                <option value="court">Court Order</option>
                                <option value="dispute">Under Dispute</option>
                            </select>
                        </label>
                        <textarea id="custody-notes" placeholder="Details/Notes" class="w-full"></textarea>
                    </div>
                    <div id="events-list" class="space-y-4 mt-4"></div>
                    <button class="add-event bg-blue-600 hover:bg-blue-700 text-white py-1 px-2 mt-2">Add Event</button>
                    <button class="print-section bg-green-600 hover:bg-green-700 text-white py-2 px-4 mt-4"><i class="fas fa-print mr-2"></i>Print/Send Section</button>
                </div>
                <div id="step-finances" class="step hidden">
                    <h2 class="text-2xl font-bold mb-4">Expense & Benefit Tracker</h2>
                    <div id="finance-dashboard" class="bg-gray-800 p-4 rounded-lg mb-4">
                        <h3 class="text-lg font-semibold">Financial Dashboard</h3>
                        <div id="finance-stats" class="text-gray-300"></div>
                    </div>
                    <label class="block">Who determined this budget?
                        <select id="budget-origin" class="mt-1">
                            <option value="mutual">Mutual Agreement</option>
                        </select>
                    </label>
                    <div id="expenses-list" class="space-y-4 mt-4"></div>
                    <button class="add-expense bg-blue-600 hover:bg-blue-700 text-white py-1 px-2 mt-2">Add Expense</button>
                    <button class="print-section bg-green-600 hover:bg-green-700 text-white py-2 px-4 mt-4"><i class="fas fa-print mr-2"></i>Print/Send Section</button>
                </div>
                <div id="step-communication" class="step hidden">
                    <h2 class="text-2xl font-bold mb-4">Communication Plan</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h3 class="text-lg font-semibold mb-2">Parent A</h3>
                            <div id="communication-a-list" class="space-y-4"></div>
                            <button class="add-communication-a bg-blue-600 hover:bg-blue-700 text-white py-1 px-2 mt-2">Add Method</button>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold mb-2">Parent B</h3>
                            <div id="communication-b-list" class="space-y-4"></div>
                            <button class="add-communication-b bg-blue-600 hover:bg-blue-700 text-white py-1 px-2 mt-2">Add Method</button>
                        </div>
                    </div>
                    <textarea id="communication-notes" placeholder="General Communication Notes (e.g., call times)" class="w-full mt-4"></textarea>
                    <button class="print-section bg-green-600 hover:bg-green-700 text-white py-2 px-4 mt-4"><i class="fas fa-print mr-2"></i>Print/Send Section</button>
                </div>
                <div id="step-summary" class="step hidden">
                    <h2 class="text-2xl font-bold mb-4">Summary & Finalize</h2>
                    <div id="summary-content" class="space-y-4"></div>
                    <div class="mt-4">
                        <h3 class="text-lg font-semibold">Select Sections to Include</h3>
                        <label class="flex items-center">
                            <input type="checkbox" name="summary-sections" value="parties" checked class="mr-2"> Parties & Children
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" name="summary-sections" value="schedule" checked class="mr-2"> Custody & Activity Schedule
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" name="summary-sections" value="finances" checked class="mr-2"> Expense & Benefit Tracker
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" name="summary-sections" value="communication" checked class="mr-2"> Communication Plan
                        </label>
                    </div>
                    <button id="preview-document" class="bg-green-600 hover:bg-green-700 text-white py-2 px-4 mt-4">Preview & Generate</button>
                </div>
            </div>

            <!-- Disclaimer Modal -->
            <div id="disclaimer-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
                <div class="bg-gray-800 p-8 rounded-lg w-full max-w-lg">
                    <h2 class="text-2xl font-bold mb-4">Disclaimer</h2>
                    <p class="text-gray-300">You are about to generate a document based on the information you provided. Flamea provides tools to help you organize your information, but this is not legal advice. You are solely responsible for the content and its application. For legal advice, consult a qualified professional or visit our free resources on the LegalHelp page.</p>
                    <label class="flex items-center mt-4">
                        <input type="checkbox" id="disclaimer-agree" class="mr-2"> I Understand and Agree
                    </label>
                    <div class="flex space-x-4 mt-4">
                        <button id="disclaimer-cancel" class="bg-gray-600 hover:bg-gray-700 text-white py-2 px-4">Cancel</button>
                        <button id="disclaimer-proceed" class="bg-green-600 hover:bg-green-700 text-white py-2 px-4 disabled:opacity-50" disabled>Proceed</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Templates -->
    <template id="parent-entry-template">
        <div class="parent-entry space-y-2 border-b border-gray-700 pb-4">
            <input type="text" placeholder="Full Name" class="name">
            <input type="text" placeholder="ID Number (Optional)" class="id">
            <select class="relationship">
                <option value="Father">Father</option>
                <option value="Mother">Mother</option>
                <option value="Grandparent">Grandparent</option>
                <option value="Other">Other</option>
            </select>
            <div class="contact-list space-y-2"></div>
            <button class="add-contact bg-blue-600 hover:bg-blue-700 text-white py-1 px-2">Add Contact</button>
            <div class="address-list space-y-2"></div>
            <button class="add-address bg-blue-600 hover:bg-blue-700 text-white py-1 px-2">Add Address</button>
            <button class="remove-entry bg-red-600 hover:bg-red-700 text-white py-1 px-2">Remove</button>
        </div>
    </template>
    <template id="contact-entry-template">
        <div class="contact-entry flex space-x-2">
            <select class="type">
                <option value="Primary Cell">Primary Cell</option>
                <option value="Work Phone">Work Phone</option>
                <option value="Email">Email</option>
                <option value="WhatsApp">WhatsApp</option>
                <option value="Other">Other</option>
            </select>
            <input type="text" placeholder="Detail/Username" class="detail">
            <button class="remove-entry bg-red-600 hover:bg-red-700 text-white py-1 px-2">Remove</button>
        </div>
    </template>
    <template id="address-entry-template">
        <div class="address-entry flex space-x-2">
            <select class="type">
                <option value="Home">Home</option>
                <option value="Work">Work</option>
                <option value="Postal">Postal</option>
                <option value="Other">Other</option>
            </select>
            <input type="text" placeholder="Street Address" class="street">
            <input type="text" placeholder="City" class="city">
            <input type="text" placeholder="Postal Code" class="postal">
            <button class="remove-entry bg-red-600 hover:bg-red-700 text-white py-1 px-2">Remove</button>
        </div>
    </template>
    <template id="child-entry-template">
        <div class="child-entry space-y-2 border-b border-gray-700 pb-4">
            <input type="text" placeholder="Child's Full Name" class="name">
            <input type="date" placeholder="Date of Birth" class="dob">
            <input type="text" placeholder="ID Number (Optional)" class="id">
            <button class="remove-entry bg-red-600 hover:bg-red-700 text-white py-1 px-2">Remove</button>
        </div>
    </template>
    <template id="event-entry-template">
        <div class="event-entry space-y-2 border-b border-gray-700 pb-4">
            <input type="text" placeholder="Event Title" class="title">
            <input type="datetime-local" placeholder="Start Date/Time" class="start">
            <input type="datetime-local" placeholder="End Date/Time" class="end">
            <select class="assigned-to">
                <option value="">Assign To</option>
            </select>
            <select class="type">
                <option value="contact">Contact Schedule</option>
                <option value="visitation">Visitation</option>
                <option value="holiday">Holiday</option>
                <option value="emergency">Emergency</option>
                <option value="school">School Activity</option>
                <option value="cultural">Cultural Event</option>
                <option value="custom">Custom</option>
            </select>
            <label><input type="checkbox" class="recurring"> Recurring Event</label>
            <div class="recurring-options hidden space-y-2">
                <select class="frequency">
                    <option value="daily">Daily</option>
                    <option value="weekly">Weekly</option>
                    <option value="monthly">Monthly</option>
                </select>
                <input type="text" placeholder="Details (e.g., Every Weekend)" class="recurring-details">
            </div>
            <textarea placeholder="Details/Notes" class="notes"></textarea>
            <button class="remove-entry bg-red-600 hover:bg-red-700 text-white py-1 px-2">Remove</button>
        </div>
    </template>
    <template id="expense-entry-template">
        <div class="expense-entry space-y-2 border-b border-gray-700 pb-4">
            <select class="category">
                <option value="Living Expenses">Living Expenses</option>
                <option value="Education">Education</option>
                <option value="Healthcare">Healthcare</option>
                <option value="Cultural Obligations">Cultural Obligations</option>
            </select>
            <input type="text" placeholder="Description" class="description">
            <input type="number" placeholder="Budgeted Cost" class="budgeted-cost" step="0.01">
            <div class="contribution-slider flex items-center space-x-4">
                <input type="range" min="0" max="100" value="50" class="parent-a-contribution slider">
                <span class="parent-a-percentage">50%</span>
                <span>|</span>
                <span class="parent-b-percentage">50%</span>
            </div>
            <input type="number" placeholder="Final Cost" class="final-cost" step="0.01">
            <button class="remove-entry bg-red-600 hover:bg-red-700 text-white py-1 px-2">Remove</button>
        </div>
    </template>
    <template id="communication-entry-template">
        <div class="communication-entry space-y-2 border-b border-gray-700 pb-4">
            <select class="contact-detail">
                <option value="">Select Contact Detail</option>
            </select>
            <select class="classification">
                <option value="Urgent">For Urgent Matters</option>
                <option value="Formal">For Formal Communication</option>
                <option value="Daily">For Daily Updates</option>
            </select>
            <button class="remove-entry bg-red-600 hover:bg-red-700 text-white py-1 px-2">Remove</button>
        </div>
    </template>

    <script>
        const ParentingPlanApp = {
            planData: {},
            currentStep: 0,
            steps: ['parties', 'schedule', 'finances', 'communication', 'summary'],
            selectedSections: [],

            init() {
                this.loadData();
                this.attachEventListeners();
            },

            loadData() {
                const savedPlan = localStorage.getItem('parentingPlan');
                if (savedPlan) {
                    this.planData = JSON.parse(savedPlan);
                } else {
                    this.planData = this.getDefaultPlanData();
                }
            },

            saveData() {
                this.planData.metadata.lastModified = new Date().toISOString();
                localStorage.setItem('parentingPlan', JSON.stringify(this.planData));
            },

            getDefaultPlanData() {
                return {
                    metadata: { lastModified: new Date().toISOString() },
                    parties: { parentA: [], parentB: [], children: [] },
                    schedule: { custody: {}, events: [] },
                    finances: { budgetOrigin: '', expenses: [] },
                    communication: { parentA: [], parentB: [], notes: '' }
                };
            },

            attachEventListeners() {
                document.querySelectorAll('.hub-card').forEach(card => {
                    card.addEventListener('click', () => {
                        const section = card.dataset.section;
                        if (section === 'wizard') this.openWizard();
                        else if (section === 'builder') this.startBuilder(['parties', 'schedule', 'finances', 'communication']);
                        else if (section === 'featured') alert('Featured forms coming soon!');
                    });
                });

                document.getElementById('wizard-next-1').addEventListener('click', () => {
                    document.getElementById('wizard-step-1').classList.add('hidden');
                    document.getElementById('wizard-step-2').classList.remove('hidden');
                });

                document.getElementById('begin-builder').addEventListener('click', () => {
                    const form = document.getElementById('wizard-step-2');
                    this.selectedSections = Array.from(form.querySelectorAll('input[name="sections"]:checked')).map(input => input.value);
                    this.startBuilder(this.selectedSections);
                });

                document.getElementById('prev-step').addEventListener('click', () => this.prevStep());
                document.getElementById('next-step').addEventListener('click', () => this.nextStep());

                document.querySelectorAll('.print-section').forEach(btn => {
                    btn.addEventListener('click', () => {
                        this.collectAllData();
                        this.saveData();
                        const section = btn.closest('.step').id.replace('step-', '');
                        this.showDisclaimer(['parties', section]);
                    });
                });

                document.getElementById('preview-document').addEventListener('click', () => {
                    this.collectAllData();
                    this.saveData();
                    const selected = Array.from(document.querySelectorAll('input[name="summary-sections"]:checked')).map(input => input.value);
                    this.showDisclaimer(selected.includes('parties') ? selected : ['parties', ...selected]);
                });

                document.getElementById('disclaimer-agree').addEventListener('change', e => {
                    document.getElementById('disclaimer-proceed').disabled = !e.target.checked;
                });

                document.getElementById('disclaimer-cancel').addEventListener('click', () => {
                    document.getElementById('disclaimer-modal').classList.add('hidden');
                });

                document.getElementById('disclaimer-proceed').addEventListener('click', () => {
                    document.getElementById('disclaimer-modal').classList.add('hidden');
                    const selected = Array.from(document.querySelectorAll('input[name="summary-sections"]:checked')).map(input => input.value);
                    this.generateDocument(selected.includes('parties') ? selected : ['parties', ...selected]);
                });

                document.addEventListener('click', e => {
                    if (e.target.classList.contains('add-parent-a')) this.addParent('parent-a', e.target);
                    if (e.target.classList.contains('add-parent-b')) this.addParent('parent-b', e.target);
                    if (e.target.classList.contains('add-child')) this.addChild(e.target);
                    if (e.target.classList.contains('add-event')) this.addEvent(e.target);
                    if (e.target.classList.contains('add-expense')) this.addExpense(e.target);
                    if (e.target.classList.contains('add-communication-a')) this.addCommunication('parent-a', e.target);
                    if (e.target.classList.contains('add-communication-b')) this.addCommunication('parent-b', e.target);
                    if (e.target.classList.contains('add-contact')) this.addContact(e.target);
                    if (e.target.classList.contains('add-address')) this.addAddress(e.target);
                    if (e.target.classList.contains('remove-entry')) e.target.closest('.parent-entry, .child-entry, .event-entry, .expense-entry, .communication-entry, .contact-entry, .address-entry').remove();
                });

                document.addEventListener('change', e => {
                    if (e.target.classList.contains('recurring')) {
                        e.target.closest('.event-entry').querySelector('.recurring-options').classList.toggle('hidden', !e.target.checked);
                    }
                    if (e.target.classList.contains('parent-a-contribution')) {
                        const percentage = e.target.value;
                        e.target.nextElementSibling.textContent = `${percentage}%`;
                        e.target.parentElement.querySelector('.parent-b-percentage').textContent = `${100 - percentage}%`;
                    }
                    if (e.target.id === 'custody-holder') {
                        document.getElementById('custody-other').classList.toggle('hidden', e.target.value !== 'other');
                    }
                });
            },

            openWizard() {
                document.getElementById('wizard-modal').classList.remove('hidden');
                document.getElementById('wizard-step-1').classList.remove('hidden');
                document.getElementById('wizard-step-2').classList.add('hidden');
            },

            startBuilder(sections) {
                this.selectedSections = sections;
                document.getElementById('wizard-modal').classList.add('hidden');
                document.getElementById('hub').classList.add('hidden');
                document.getElementById('builder').classList.remove('hidden');
                this.showStep(0);
                this.loadExistingData();
            },

            showStep(index) {
                this.currentStep = index;
                document.querySelectorAll('.step').forEach(step => step.classList.add('hidden'));
                document.getElementById(`step-${this.steps[index]}`).classList.remove('hidden');
                document.getElementById('prev-step').disabled = index === 0;
                document.getElementById('next-step').textContent = index === this.steps.length - 1 ? 'Finish' : 'Next';
                if (index === this.steps.length - 1) this.showSummary();
            },

            prevStep() {
                if (this.currentStep > 0) {
                    this.collectAllData();
                    this.saveData();
                    this.showStep(this.currentStep - 1);
                }
            },

            nextStep() {
                if (this.currentStep < this.steps.length - 1) {
                    this.collectAllData();
                    this.saveData();
                    this.showStep(this.currentStep + 1);
                }
            },

            showSummary() {
                const summary = document.getElementById('summary-content');
                summary.innerHTML = `
                    <h3 class="text-lg font-semibold">Parties & Children</h3>
                    <p>Parents A: ${this.planData.parties.parentA.map(p => p.name).join(', ') || 'None'}</p>
                    <p>Parents B: ${this.planData.parties.parentB.map(p => p.name).join(', ') || 'None'}</p>
                    <p>Children: ${this.planData.parties.children.map(c => c.name).join(', ') || 'None'}</p>
                    ${this.selectedSections.includes('schedule') ? `
                        <h3 class="text-lg font-semibold mt-4">Custody & Activity Schedule</h3>
                        <p>Custody: ${this.planData.schedule.custody.holder || 'None'}</p>
                        <p>Events: ${this.planData.schedule.events.length} logged</p>
                    ` : ''}
                    ${this.selectedSections.includes('finances') ? `
                        <h3 class="text-lg font-semibold mt-4">Expense & Benefit Tracker</h3>
                        <p>Budget Origin: ${this.planData.finances.budgetOrigin || 'None'}</p>
                        <p>Expenses: ${this.planData.finances.expenses.length} logged</p>
                    ` : ''}
                    ${this.selectedSections.includes('communication') ? `
                        <h3 class="text-lg font-semibold mt-4">Communication Plan</h3>
                        <p>Parent A Methods: ${this.planData.communication.parentA.length} logged</p>
                        <p>Parent B Methods: ${this.planData.communication.parentB.length} logged</p>
                    ` : ''}
                `;
            },

            addParent(type, button, data = {}) {
                const list = button ? button.closest('.step').querySelector(`#${type}-list`) : document.querySelector(`#${type}-list`);
                const entry = document.getElementById('parent-entry-template').content.cloneNode(true);
                entry.querySelector('.name').value = data.name || '';
                entry.querySelector('.id').value = data.id || '';
                entry.querySelector('.relationship').value = data.relationship || 'Father';
                list.appendChild(entry);
                (data.contacts || []).forEach(contact => this.addContact(null, contact, entry.querySelector('.contact-list')));
                (data.addresses || []).forEach(address => this.addAddress(null, address, entry.querySelector('.address-list')));
            },

            addContact(button, data = {}, parent = null) {
                const list = parent || button.closest('.parent-entry').querySelector('.contact-list');
                const entry = document.getElementById('contact-entry-template').content.cloneNode(true);
                entry.querySelector('.type').value = data.type || 'Primary Cell';
                entry.querySelector('.detail').value = data.detail || '';
                list.appendChild(entry);
            },

            addAddress(button, data = {}, parent = null) {
                const list = parent || button.closest('.parent-entry').querySelector('.address-list');
                const entry = document.getElementById('address-entry-template').content.cloneNode(true);
                entry.querySelector('.type').value = data.type || 'Home';
                entry.querySelector('.street').value = data.street || '';
                entry.querySelector('.city').value = data.city || '';
                entry.querySelector('.postal').value = data.postal || '';
                list.appendChild(entry);
            },

            addChild(button, data = {}) {
                const list = button ? button.closest('.step').querySelector('#children-list') : document.querySelector('#children-list');
                const entry = document.getElementById('child-entry-template').content.cloneNode(true);
                entry.querySelector('.name').value = data.name || '';
                entry.querySelector('.dob').value = data.dob || '';
                entry.querySelector('.id').value = data.id || '';
                list.appendChild(entry);
            },

            addEvent(button, data = {}) {
                const list = button ? button.closest('.step').querySelector('#events-list') : document.querySelector('#events-list');
                const entry = document.getElementById('event-entry-template').content.cloneNode(true);
                entry.querySelector('.title').value = data.title || '';
                entry.querySelector('.start').value = data.start || '';
                entry.querySelector('.end').value = data.end || '';
                entry.querySelector('.type').value = data.type || 'contact';
                entry.querySelector('.recurring').checked = data.recurring || false;
                entry.querySelector('.recurring-options').classList.toggle('hidden', !data.recurring);
                entry.querySelector('.frequency').value = data.frequency || 'daily';
                entry.querySelector('.recurring-details').value = data.recurringDetails || '';
                entry.querySelector('.notes').value = data.notes || '';
                list.appendChild(entry);
                const assignSelect = entry.querySelector('.assigned-to');
                [...this.planData.parties.parentA, ...this.planData.parties.parentB].forEach(parent => {
                    const option = document.createElement('option');
                    option.value = parent.name;
                    option.textContent = parent.name;
                    option.selected = parent.name === data.assignedTo;
                    assignSelect.appendChild(option);
                });
            },

            addExpense(button, data = {}) {
                const list = button ? button.closest('.step').querySelector('#expenses-list') : document.querySelector('#expenses-list');
                const entry = document.getElementById('expense-entry-template').content.cloneNode(true);
                entry.querySelector('.category').value = data.category || 'Living Expenses';
                entry.querySelector('.description').value = data.description || '';
                entry.querySelector('.budgeted-cost').value = data.budgetedCost || '';
                entry.querySelector('.parent-a-contribution').value = data.parentAContribution || 50;
                entry.querySelector('.parent-a-percentage').textContent = `${data.parentAContribution || 50}%`;
                entry.querySelector('.parent-b-percentage').textContent = `${100 - (data.parentAContribution || 50)}%`;
                entry.querySelector('.final-cost').value = data.finalCost || '';
                list.appendChild(entry);
            },

            addCommunication(type, button, data = {}) {
                const list = button ? button.closest('.step').querySelector(`#communication-${type.split('-')[1]}-list`) : document.querySelector(`#communication-${type.split('-')[1]}-list`);
                const entry = document.getElementById('communication-entry-template').content.cloneNode(true);
                entry.querySelector('.classification').value = data.classification || 'Urgent';
                list.appendChild(entry);
                const contactSelect = entry.querySelector('.contact-detail');
                const contacts = this.planData.parties[type].flatMap(p => p.contacts || []);
                contacts.forEach(contact => {
                    const option = document.createElement('option');
                    option.value = `${contact.type}:${contact.detail}`;
                    option.textContent = `${contact.type}: ${contact.detail}`;
                    option.selected = `${contact.type}:${contact.detail}` === data.detail;
                    contactSelect.appendChild(option);
                });
            },

            collectAllData() {
                this.planData.parties.parentA = [];
                document.querySelectorAll('#parent-a-list .parent-entry').forEach(entry => {
                    const contacts = [];
                    entry.querySelectorAll('.contact-entry').forEach(contact => {
                        contacts.push({
                            type: contact.querySelector('.type').value,
                            detail: contact.querySelector('.detail').value
                        });
                    });
                    const addresses = [];
                    entry.querySelectorAll('.address-entry').forEach(address => {
                        addresses.push({
                            type: address.querySelector('.type').value,
                            street: address.querySelector('.street').value,
                            city: address.querySelector('.city').value,
                            postal: address.querySelector('.postal').value
                        });
                    });
                    this.planData.parties.parentA.push({
                        name: entry.querySelector('.name').value,
                        id: entry.querySelector('.id').value,
                        relationship: entry.querySelector('.relationship').value,
                        contacts,
                        addresses
                    });
                });

                this.planData.parties.parentB = [];
                document.querySelectorAll('#parent-b-list .parent-entry').forEach(entry => {
                    const contacts = [];
                    entry.querySelectorAll('.contact-entry').forEach(contact => {
                        contacts.push({
                            type: contact.querySelector('.type').value,
                            detail: contact.querySelector('.detail').value
                        });
                    });
                    const addresses = [];
                    entry.querySelectorAll('.address-entry').forEach(address => {
                        addresses.push({
                            type: address.querySelector('.type').value,
                            street: address.querySelector('.street').value,
                            city: address.querySelector('.city').value,
                            postal: address.querySelector('.postal').value
                        });
                    });
                    this.planData.parties.parentB.push({
                        name: entry.querySelector('.name').value,
                        id: entry.querySelector('.id').value,
                        relationship: entry.querySelector('.relationship').value,
                        contacts,
                        addresses
                    });
                });

                this.planData.parties.children = [];
                document.querySelectorAll('#children-list .child-entry').forEach(entry => {
                    this.planData.parties.children.push({
                        name: entry.querySelector('.name').value,
                        dob: entry.querySelector('.dob').value,
                        id: entry.querySelector('.id').value
                    });
                });

                this.planData.schedule.custody = {
                    holder: document.getElementById('custody-holder').value || '',
                    otherName: document.getElementById('custody-other-name')?.value || '',
                    otherRelationship: document.getElementById('custody-other-relationship')?.value || '',
                    decision: document.getElementById('custody-decision').value || '',
                    notes: document.getElementById('custody-notes').value || ''
                };

                this.planData.schedule.events = [];
                document.querySelectorAll('#events-list .event-entry').forEach(entry => {
                    this.planData.schedule.events.push({
                        title: entry.querySelector('.title').value,
                        start: entry.querySelector('.start').value,
                        end: entry.querySelector('.end').value,
                        assignedTo: entry.querySelector('.assigned-to').value,
                        type: entry.querySelector('.type').value,
                        recurring: entry.querySelector('.recurring').checked,
                        frequency: entry.querySelector('.frequency')?.value || '',
                        recurringDetails: entry.querySelector('.recurring-details')?.value || '',
                        notes: entry.querySelector('.notes').value
                    });
                });

                this.planData.finances.budgetOrigin = document.getElementById('budget-origin').value || '';
                this.planData.finances.expenses = [];
                document.querySelectorAll('#expenses-list .expense-entry').forEach(entry => {
                    this.planData.finances.expenses.push({
                        category: entry.querySelector('.category').value,
                        description: entry.querySelector('.description').value,
                        budgetedCost: parseFloat(entry.querySelector('.budgeted-cost').value) || 0,
                        parentAContribution: parseInt(entry.querySelector('.parent-a-contribution').value) || 50,
                        parentBContribution: 100 - (parseInt(entry.querySelector('.parent-a-contribution').value) || 50),
                        finalCost: parseFloat(entry.querySelector('.final-cost').value) || parseFloat(entry.querySelector('.budgeted-cost').value) || 0
                    });
                });

                this.planData.communication.parentA = [];
                document.querySelectorAll('#communication-a-list .communication-entry').forEach(entry => {
                    this.planData.communication.parentA.push({
                        detail: entry.querySelector('.contact-detail').value,
                        classification: entry.querySelector('.classification').value
                    });
                });

                this.planData.communication.parentB = [];
                document.querySelectorAll('#communication-b-list .communication-entry').forEach(entry => {
                    this.planData.communication.parentB.push({
                        detail: entry.querySelector('.contact-detail').value,
                        classification: entry.querySelector('.classification').value
                    });
                });

                this.planData.communication.notes = document.getElementById('communication-notes').value || '';

                this.updateDashboards();
            },

            updateDashboards() {
                // Time Dashboard
                const timeStats = document.getElementById('time-stats');
                if (timeStats) {
                    const timeByParent = {};
                    [...this.planData.parties.parentA, ...this.planData.parties.parentB].forEach(p => timeByParent[p.name] = 0);
                    this.planData.schedule.events.forEach(event => {
                        if (event.start && event.end && event.assignedTo) {
                            const start = new Date(event.start);
                            const end = new Date(event.end);
                            if (end > start) {
                                const hours = (end - start) / (1000 * 60 * 60);
                                timeByParent[event.assignedTo] = (timeByParent[event.assignedTo] || 0) + hours;
                            }
                        }
                    });
                    let html = '';
                    for (const [parent, hours] of Object.entries(timeByParent)) {
                        const days = Math.floor(hours / 24);
                        const remainingHours = (hours % 24).toFixed(1);
                        html += `<p>${parent}: ${days} days, ${remainingHours} hours</p>`;
                    }
                    timeStats.innerHTML = html || 'No events logged.';
                }

                // Finance Dashboard
                const financeStats = document.getElementById('finance-stats');
                if (financeStats) {
                    let totalA = 0, totalB = 0;
                    this.planData.finances.expenses.forEach(expense => {
                        const cost = expense.finalCost || expense.budgetedCost;
                        totalA += (cost * expense.parentAContribution / 100);
                        totalB += (cost * expense.parentBContribution / 100);
                    });
                    const total = totalA + totalB;
                    financeStats.innerHTML = `
                        <p>Parent A: $${totalA.toFixed(2)} (${total ? (totalA / total * 100).toFixed(1) : 0}%)</p>
                        <p>Parent B: $${totalB.toFixed(2)} (${total ? (totalB / total * 100).toFixed(1) : 0}%)</p>
                    `;
                }
            },

            loadExistingData() {
                this.planData.parties.parentA.forEach(parent => this.addParent('parent-a', null, parent));
                this.planData.parties.parentB.forEach(parent => this.addParent('parent-b', null, parent));
                this.planData.parties.children.forEach(child => this.addChild(null, child));
                this.planData.schedule.events.forEach(event => this.addEvent(null, event));
                this.planData.finances.expenses.forEach(expense => this.addExpense(null, expense));
                this.planData.communication.parentA.forEach(method => this.addCommunication('parent-a', null, method));
                this.planData.communication.parentB.forEach(method => this.addCommunication('parent-b', null, method));
                if (this.planData.schedule.custody) {
                    document.getElementById('custody-holder').value = this.planData.schedule.custody.holder || '';
                    document.getElementById('custody-other').classList.toggle('hidden', this.planData.schedule.custody.holder !== 'other');
                    document.getElementById('custody-other-name').value = this.planData.schedule.custody.otherName || '';
                    document.getElementById('custody-other-relationship').value = this.planData.schedule.custody.otherRelationship || '';
                    document.getElementById('custody-decision').value = this.planData.schedule.custody.decision || '';
                    document.getElementById('custody-notes').value = this.planData.schedule.custody.notes || '';
                }
                document.getElementById('budget-origin').value = this.planData.finances.budgetOrigin || '';
                document.getElementById('communication-notes').value = this.planData.communication.notes || '';
                this.updateDashboards();
            },

            showDisclaimer(sections) {
                this.selectedSections = sections;
                document.getElementById('disclaimer-modal').classList.remove('hidden');
                document.getElementById('disclaimer-agree').checked = false;
                document.getElementById('disclaimer-proceed').disabled = true;
            },

            generateDocument(sections) {
                let html = `
                    <!DOCTYPE html>
                    <html lang="en">
                    <head>
                        <meta charset="UTF-8">
                        <title>Parenting Plan</title>
                        <style>
                            body { font-family: Arial, sans-serif; margin: 40px; }
                            .cover-page { text-align: center; margin-bottom: 40px; }
                            .section { margin-bottom: 20px; }
                            h1 { font-size: 24px; }
                            h2 { font-size: 20px; }
                            ul { list-style-type: none; padding: 0; }
                            .footer { position: fixed; bottom: 0; width: 100%; text-align: center; font-size: 12px; opacity: 0.5; }
                            .watermark { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); opacity: 0.1; font-size: 48px; }
                        </style>
                    </head>
                    <body>
                        <div class="watermark">Flamea</div>
                        <!-- Cover Page -->
                        <div class="cover-page">
                            <h1>The Father's Armoury</h1>
                            <h2>Parenting Plan</h2>
                            <p>Document ID: FLAMEA-PP-${Date.now()}</p>
                            <p>Generated on: ${new Date().toLocaleDateString()}</p>
                            <p>Last Modified: ${new Date(this.planData.metadata.lastModified).toLocaleDateString()}</p>
                        </div>

                        <!-- Sections -->
                        ${sections.includes('parties') ? `
                            <div class="section">
                                <h2>Parties & Children</h2>
                                <h3>Parent A</h3>
                                <ul>
                                    ${this.planData.parties.parentA.map(p => `
                                        <li>${p.name} (${p.relationship}) - ID: ${p.id || 'N/A'}</li>
                                        <ul>
                                            ${p.contacts.map(c => `<li>Contact: ${c.type} - ${c.detail}</li>`).join('')}
                                            ${p.addresses.map(a => `<li>Address: ${a.type} - ${a.street}, ${a.city}, ${a.postal}</li>`).join('')}
                                        </ul>
                                    `).join('')}
                                </ul>
                                <h3>Parent B</h3>
                                <ul>
                                    ${this.planData.parties.parentB.map(p => `
                                        <li>${p.name} (${p.relationship}) - ID: ${p.id || 'N/A'}</li>
                                        <ul>
                                            ${p.contacts.map(c => `<li>Contact: ${c.type} - ${c.detail}</li>`).join('')}
                                            ${p.addresses.map(a => `<li>Address: ${a.type} - ${a.street}, ${a.city}, ${a.postal}</li>`).join('')}
                                        </ul>
                                    `).join('')}
                                </ul>
                                <h3>Children</h3>
                                <ul>
                                    ${this.planData.parties.children.map(c => `<li>${c.name} - DOB: ${c.dob || 'N/A'}, ID: ${c.id || 'N/A'}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}

                        ${sections.includes('schedule') ? `
                            <div class="section">
                                <h2>Custody & Activity Schedule</h2>
                                <p>Custody Holder: ${this.planData.schedule.custody.holder === 'other' ? `${this.planData.schedule.custody.otherName} (${this.planData.schedule.custody.otherRelationship})` : this.planData.schedule.custody.holder || 'None'}</p>
                                <p>Decision: ${this.planData.schedule.custody.decision || 'None'}</p>
                                <p>Notes: ${this.planData.schedule.custody.notes || 'None'}</p>
                                <h3>Events</h3>
                                <ul>
                                    ${this.planData.schedule.events.map(e => `
                                        <li>${e.title} (${e.type}) - ${e.start} to ${e.end}, Assigned to: ${e.assignedTo || 'N/A'}</li>
                                        ${e.recurring ? `<li>Recurring: ${e.frequency} (${e.recurringDetails})</li>` : ''}
                                        <li>Notes: ${e.notes}</li>
                                    `).join('')}
                                </ul>
                            </div>
                        ` : ''}

                        ${sections.includes('finances') ? `
                            <div class="section">
                                <h2>Expense & Benefit Tracker</h2>
                                <p>Budget Origin: ${this.planData.finances.budgetOrigin || 'None'}</p>
                                <ul>
                                    ${this.planData.finances.expenses.map(e => `
                                        <li>${e.category}: ${e.description} - Budget: $${e.budgetedCost.toFixed(2)}, Final: $${e.finalCost.toFixed(2)}, A: ${e.parentAContribution}%, B: ${e.parentBContribution}%</li>
                                    `).join('')}
                                </ul>
                            </div>
                        ` : ''}

                        ${sections.includes('communication') ? `
                            <div class="section">
                                <h2>Communication Plan</h2>
                                <h3>Parent A</h3>
                                <ul>
                                    ${this.planData.communication.parentA.map(m => `<li>${m.detail} (${m.classification})</li>`).join('')}
                                </ul>
                                <h3>Parent B</h3>
                                <ul>
                                    ${this.planData.communication.parentB.map(m => `<li>${m.detail} (${m.classification})</li>`).join('')}
                                </ul>
                                <p>Notes: ${this.planData.communication.notes || 'None'}</p>
                            </div>
                        ` : ''}

                        <!-- Annexure -->
                        <div class="section">
                            <h2>Annexure A: Definitions & Key Principles</h2>
                            <p>"Best Interests of the Child": Decisions prioritize the child's well-being as per South African law.</p>
                        </div>

                        <!-- Back Cover -->
                        <div class="section">
                            <h2>About Flamea</h2>
                            <p>Mission: To empower fathers by dismantling systemic discrimination in family law.</p>
                            <p>Contact: info@flamea.org | www.flamea.com</p>
                        </div>

                        <div class="footer">
                            <p>Flamea.com - Empowering Parents | Page <span></p>
                        </div>
                    </body>
                    </html>
                `;
                const newTab = window.open('');
                newTab.document.write(html);
                newTab.document.close();
            }
        };

        ParentingPlanApp.init();
    </script>
</body>
</html>
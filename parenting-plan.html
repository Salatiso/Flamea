<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parenting Plan - The Co-Parenting Compass</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Slab:wght@700&family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Open Sans', sans-serif; background-color: #111827; color: #d1d5db; }
        .main-container { display: flex; min-height: 100vh; }
        .main-content { flex-grow: 1; overflow-y: auto; }
        #main-content-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; background-size: cover; background-position: center; background-attachment: fixed; transition: background-image 1s ease-in-out; }
        .content-wrapper { background-color: rgba(17, 24, 39, 0.85); backdrop-filter: blur(10px); }
        .view-container, .step-container { display: none; }
        .view-container.active, .step-container.active { display: block; animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .option-card { transition: all 0.3s ease-in-out; cursor: pointer; border: 1px solid #374151; }
        .option-card:hover { transform: translateY(-5px); border-color: #3b82f6; box-shadow: 0 10px 15px -3px rgba(59, 130, 246, 0.1), 0 4px 6px -2px rgba(59, 130, 246, 0.05); }
        
        .form-input, .form-select, .form-textarea { background-color: #374151; border: 1px solid #4b5563; border-radius: 0.375rem; padding: 0.75rem; color: white; transition: border-color 0.2s; width: 100%; }
        .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: #3b82f6; ring: 0; }
        .form-label { font-weight: 600; color: #9ca3af; margin-bottom: 0.5rem; display: block; font-size: 0.875rem; }
        .btn-primary { background-color: #2563eb; color: white; font-weight: 600; padding: 0.75rem 1.5rem; border-radius: 0.5rem; transition: background-color 0.3s; border:0; cursor: pointer; }
        .btn-primary:hover:not(:disabled) { background-color: #1d4ed8; }
        .btn-primary:disabled { background-color: #4b5563; cursor: not-allowed; }
        .btn-secondary { background-color: #4b5563; color: white; font-weight: 600; padding: 0.5rem 1rem; border-radius: 0.5rem; transition: background-color 0.3s; border:0; cursor: pointer;}
        .btn-secondary:hover:not(:disabled) { background-color: #6b7280; }
        .btn-danger { background-color: #dc2626; color: white; font-weight: 600; padding: 0.25rem 0.5rem; border-radius: 0.5rem; transition: background-color: 0.3s; border:0; font-size: 0.75rem; cursor: pointer;}
        .btn-danger:hover { background-color: #b91c1c; }

        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.7); backdrop-filter: blur(5px); align-items: center; justify-content: center;}
        .modal-content { background-color: #1f2937; padding: 2rem; border-radius: 0.5rem; width: 90%; max-width: 600px; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
        
        .contribution-slider { -webkit-appearance: none; width: 100%; height: 8px; background: #4b5563; border-radius: 5px; outline: none; opacity: 0.7; transition: opacity .2s; }
        .contribution-slider:hover { opacity: 1; }
        .contribution-slider::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 20px; height: 20px; background: #3b82f6; border-radius: 50%; cursor: pointer; }
        .contribution-slider::-moz-range-thumb { width: 20px; height: 20px; background: #3b82f6; border-radius: 50%; cursor: pointer; }
        
        .party-card { border: 1px solid #374151; border-radius: 0.5rem; padding: 1rem; margin-bottom: 1rem; background-color: #1f2937; }
        .expense-category { border: 1px solid #374151; border-radius: 0.5rem; padding: 1rem; margin-bottom: 1rem; background-color: #1f2937; }
        .event-log-item { border: 1px solid #374151; border-radius: 0.5rem; padding: 1rem; margin-bottom: 0.5rem; background-color: #1f2937; }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- Sidebar Placeholder -->
        <div id="sidebar-placeholder" class="hidden lg:block flex-shrink-0 w-64 bg-gray-900/80 backdrop-blur-sm"></div>
        <div id="main-content-bg"></div>
        <main class="main-content flex-1">
            <div class="content-wrapper min-h-full p-6 sm:p-8">
                <div class="max-w-7xl mx-auto">
                    <!-- Landing Page View -->
                    <div id="landing-view" class="view-container active">
                         <header class="text-center mb-12">
                             <div class="inline-block p-6 md:p-8">
                                <h1 class="text-4xl md:text-5xl font-bold text-white tracking-tight font-roboto-slab">The Co-Parenting Compass</h1>
                                <p class="text-lg md:text-xl text-gray-400 mt-4 max-w-3xl mx-auto">Navigate your parenting journey with clarity and confidence. Create a comprehensive, objective plan to ensure the best for your children.</p>
                            </div>
                        </header>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                            <div id="start-wizard-btn" class="option-card bg-gray-800 p-8 rounded-xl text-center">
                                <i class="fas fa-magic text-5xl text-blue-400 mb-4"></i>
                                <h4 class="text-2xl font-bold text-white">Automated Wizard</h4>
                                <p class="text-gray-400">The recommended path. Answer a few questions to build a plan tailored to your needs.</p>
                            </div>
                            <div id="start-manual-btn" class="option-card bg-gray-800 p-8 rounded-xl text-center">
                                <i class="fas fa-file-lines text-5xl text-teal-400 mb-4"></i>
                                <h4 class="text-2xl font-bold text-white">Manual Builder</h4>
                                <p class="text-gray-400">Go straight to the full plan builder and select the sections you need.</p>
                            </div>
                            <div id="featured-forms-card" class="option-card bg-gray-800 p-8 rounded-xl text-center">
                                 <i class="fas fa-star text-5xl text-amber-400 mb-4"></i>
                                 <h4 class="text-2xl font-bold text-white">Featured Forms</h4>
                                 <p class="text-gray-400">Quickly access other useful templates like Affidavits or School Letters.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Wizard View -->
                    <div id="wizard-view" class="view-container"></div>

                    <!-- Main Builder View -->
                    <div id="builder-view" class="view-container">
                         <div id="builder-header" class="flex justify-between items-center mb-6">
                            <h2 class="text-3xl font-bold font-roboto-slab">Parenting Plan Builder</h2>
                            <div><button id="save-plan-btn" class="btn-secondary"><i class="fas fa-save mr-2"></i>Save Progress</button></div>
                        </div>
                        <div id="steps-container"></div>
                        <div id="navigation-container" class="flex justify-between items-center mt-8 pt-6 border-t border-gray-600"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="alert-modal" class="modal">
      <div class="modal-content text-center">
        <h3 id="alert-modal-title" class="text-2xl font-bold text-white mb-4"></h3>
        <p id="alert-modal-message" class="text-gray-300 mb-6"></p>
        <button id="alert-modal-close" class="btn-primary w-full">OK</button>
      </div>
    </div>
    <div id="disclaimer-modal" class="modal">
      <div class="modal-content">
        <h3 class="text-2xl font-bold text-white mb-4">Important Disclaimer</h3>
        <p class="text-gray-300 mb-6 text-sm">You are about to generate a document based on the information you have provided. Flamea provides tools to help you organize your information, but this is **not legal advice**. The user is solely responsible for the content and its application. For legal advice, please consult a qualified professional or visit our free resources on the LegalHelp page. By proceeding, you acknowledge that you have read and understood this disclaimer.</p>
        <label class="flex items-center space-x-3 mb-6 cursor-pointer">
            <input type="checkbox" id="disclaimer-agree" class="h-5 w-5 rounded bg-gray-600 border-gray-500 text-blue-600 focus:ring-blue-500">
            <span class="text-white">I Understand and Agree</span>
        </label>
        <div class="flex justify-end gap-4">
             <button id="disclaimer-cancel" class="btn-secondary">Cancel</button>
             <button id="disclaimer-proceed" class="btn-primary" disabled>Proceed</button>
        </div>
      </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- STATE MANAGEMENT & DATA ---
            const state = {
                currentView: 'landing-view', 
                wizardStep: 0, 
                builderStep: 0,
                allSections: [
                    { id: 'parties', title: "Parties, Guardians & Children", icon: 'fa-users', render: null, collect: null, generate: null },
                    { id: 'custody', title: 'Custody & Activity Schedule', icon: 'fa-calendar-days', render: null, collect: null, generate: null },
                    { id: 'expenses', title: 'Expense & Benefit Tracker', icon: 'fa-hand-holding-dollar', render: null, collect: null, generate: null },
                    { id: 'communication', title: 'Communication Plan', icon: 'fa-comments', render: null, collect: null, generate: null },
                    { id: 'summary', title: 'Summary & Generation', icon: 'fa-check-double', render: null, collect: () => {}, generate: () => '' },
                ],
                selectedSections: [], 
                planData: {}, 
                partyNames: { A: 'Parent A', B: 'Parent B' }
            };

            const dropdownOptions = {
                relationship: ['Father', 'Mother', 'Grandfather', 'Grandmother', 'Uncle', 'Aunt', 'Legal Guardian', 'Other'],
                addressType: ['Home', 'Work', 'Postal', 'Other'],
                contactType: ['Primary Cell', 'Work Phone', 'Email', 'WhatsApp', 'Facebook', 'Other'],
                eventType: ['Contact Schedule', 'Visitation', 'Holiday', 'Emergency', 'School Activity', 'Cultural Event', 'Other'],
                custodyDecision: ['Mutual Agreement', 'Court Order', 'In Dispute', 'Other'],
                expenseCategory: ['Living Expenses', 'Education', 'Healthcare', 'Cultural Obligations', 'Other'],
                communicationClassification: ['For Urgent Matters', 'For Formal Communication', 'For Daily Updates']
            };

            // --- DOM ELEMENT REFERENCES ---
            const views = { 
                landing: document.getElementById('landing-view'), 
                wizard: document.getElementById('wizard-view'), 
                builder: document.getElementById('builder-view') 
            };
            const buttons = { 
                startWizard: document.getElementById('start-wizard-btn'), 
                startManual: document.getElementById('start-manual-btn'), 
                savePlan: document.getElementById('save-plan-btn') 
            };
            const containers = { 
                steps: document.getElementById('steps-container'), 
                navigation: document.getElementById('navigation-container'), 
                sidebar: document.getElementById('sidebar-placeholder'), 
                bg: document.getElementById('main-content-bg')
            };
            const alertModal = { 
                modal: document.getElementById('alert-modal'), 
                title: document.getElementById('alert-modal-title'), 
                message: document.getElementById('alert-modal-message'), 
                close: document.getElementById('alert-modal-close') 
            };
            const disclaimerModal = { 
                modal: document.getElementById('disclaimer-modal'), 
                agree: document.getElementById('disclaimer-agree'), 
                cancel: document.getElementById('disclaimer-cancel'), 
                proceed: document.getElementById('disclaimer-proceed') 
            };
            
            // --- FUNCTION IMPLEMENTATIONS ---

            // Dynamic UI & Helper Functions
            function generateOptions(arr, selected = '') { 
                return arr.map(opt => `<option value="${opt}" ${opt === selected ? 'selected' : ''}>${opt}</option>`).join(''); 
            }

            function getPartyNames() { 
                const names = []; 
                document.querySelectorAll('.party-name').forEach(input => { 
                    if (input.value.trim()) names.push(input.value.trim()); 
                }); 
                return names.length > 0 ? names : ['Parent A', 'Parent B']; 
            }

            function addGuardian(side) {
                const container = document.getElementById(`${side}-parties-container`);
                const guardianId = `guardian-${Date.now()}`;
                const guardianHtml = `
                    <div class="party-card">
                        <div class="flex justify-between items-center mb-4">
                            <h4 class="font-semibold">Guardian/Party</h4>
                            <button class="btn-danger remove-guardian-btn">Remove</button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="form-label">Full Name</label>
                                <input type="text" class="form-input party-name" data-party-name="${guardianId}">
                            </div>
                            <div>
                                <label class="form-label">Relationship to Child</label>
                                <select class="form-select">
                                    ${generateOptions(dropdownOptions.relationship)}
                                </select>
                            </div>
                        </div>
                        <div class="addresses-sub-container mb-4">
                            <h5 class="font-medium mb-2">Addresses</h5>
                        </div>
                        <button class="btn-secondary add-address-btn mb-4">Add Address</button>
                        <div class="contacts-sub-container mb-4">
                            <h5 class="font-medium mb-2">Contact Information</h5>
                        </div>
                        <button class="btn-secondary add-contact-btn">Add Contact</button>
                    </div>`;
                container.insertAdjacentHTML('beforeend', guardianHtml);
                updateAllPartyDropdowns();
            }

            function addAddress(container) {
                const addressHtml = `
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-2 p-3 bg-gray-800 rounded">
                        <div>
                            <label class="form-label">Address Type</label>
                            <select class="form-select">
                                ${generateOptions(dropdownOptions.addressType)}
                            </select>
                        </div>
                        <div class="md:col-span-2">
                            <label class="form-label">Full Address</label>
                            <div class="flex gap-2">
                                <input type="text" class="form-input" placeholder="Street, City, Province, Postal Code">
                                <button class="btn-danger remove-sub-item-btn">×</button>
                            </div>
                        </div>
                    </div>`;
                container.insertAdjacentHTML('beforeend', addressHtml);
            }

            function addContact(container) {
                const contactHtml = `
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-2 p-3 bg-gray-800 rounded">
                        <div>
                            <label class="form-label">Contact Type</label>
                            <select class="form-select">
                                ${generateOptions(dropdownOptions.contactType)}
                            </select>
                        </div>
                        <div class="md:col-span-2">
                            <label class="form-label">Contact Information</label>
                            <div class="flex gap-2">
                                <input type="text" class="form-input" placeholder="Phone number, email, etc.">
                                <button class="btn-danger remove-sub-item-btn">×</button>
                            </div>
                        </div>
                    </div>`;
                container.insertAdjacentHTML('beforeend', contactHtml);
            }

            function addChild() {
                const container = document.getElementById('children-container');
                const childHtml = `
                    <div class="party-card">
                        <div class="flex justify-between items-center mb-4">
                            <h4 class="font-semibold">Child</h4>
                            <button class="btn-danger remove-sub-item-btn">Remove</button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="form-label">Full Name</label>
                                <input type="text" class="form-input">
                            </div>
                            <div>
                                <label class="form-label">Date of Birth</label>
                                <input type="date" class="form-input">
                            </div>
                            <div>
                                <label class="form-label">Primary Residence</label>
                                <select class="form-select party-dropdown">
                                    <option value="">Select Parent/Guardian</option>
                                </select>
                            </div>
                        </div>
                    </div>`;
                container.insertAdjacentHTML('beforeend', childHtml);
                updateAllPartyDropdowns();
            }

            function addExpenseCategory(name = '') {
                const container = document.getElementById('expense-categories-container');
                const categoryId = `category-${Date.now()}`;
                const categoryHtml = `
                    <div class="expense-category" data-category-id="${categoryId}">
                        <div class="flex justify-between items-center mb-4">
                            <input type="text" class="form-input category-name" value="${name}" placeholder="Category Name">
                            <button class="btn-danger remove-category-btn">Remove Category</button>
                        </div>
                        <div class="expense-items-container mb-4"></div>
                        <button class="btn-secondary add-expense-item-btn">Add Expense Item</button>
                    </div>`;
                container.insertAdjacentHTML('beforeend', categoryHtml);
                updateExpenseDashboard();
            }

            function addExpenseItem(container) {
                const partyNames = getPartyNames();
                const itemHtml = `
                    <div class="grid grid-cols-1 md:grid-cols-6 gap-4 mb-2 p-3 bg-gray-800 rounded">
                        <div>
                            <label class="form-label">Item</label>
                            <input type="text" class="form-input expense-item" placeholder="Expense description">
                        </div>
                        <div>
                            <label class="form-label">Budget</label>
                            <input type="number" class="form-input expense-budget" placeholder="0.00" step="0.01">
                        </div>
                        <div>
                            <label class="form-label">Final Cost</label>
                            <input type="number" class="form-input expense-final" placeholder="0.00" step="0.01">
                        </div>
                        <div class="md:col-span-2">
                            <label class="form-label">Contribution Split</label>
                            <div class="flex items-center space-x-2">
                                <span class="text-xs percent-a">50</span>%
                                <input type="range" class="contribution-slider flex-1" min="0" max="100" value="50">
                                <span class="text-xs percent-b">50</span>%
                            </div>
                            <div class="text-xs text-gray-400 mt-1">${partyNames[0] || 'Parent A'} - ${partyNames[1] || 'Parent B'}</div>
                        </div>
                        <div class="flex items-end">
                            <button class="btn-danger remove-sub-item-btn">Remove</button>
                        </div>
                    </div>`;
                container.insertAdjacentHTML('beforeend', itemHtml);
                updateExpenseDashboard();
            }

            function addCommunicationMethod(container, parties) {
                const partyOptions = parties.map(p => `<option value="${p.name}">${p.name}</option>`).join('');
                const methodHtml = `
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-2 p-3 bg-gray-800 rounded">
                        <div>
                            <label class="form-label">Method</label>
                            <input type="text" class="form-input" placeholder="e.g., WhatsApp, Email">
                        </div>
                        <div>
                            <label class="form-label">From</label>
                            <select class="form-select">${partyOptions}</select>
                        </div>
                        <div>
                            <label class="form-label">To</label>
                            <select class="form-select">${partyOptions}</select>
                        </div>
                        <div class="flex items-end">
                            <button class="btn-danger remove-sub-item-btn">Remove</button>
                        </div>
                    </div>`;
                container.insertAdjacentHTML('beforeend', methodHtml);
            }

            function updatePartyNames(e) {
                const input = e.target;
                const partyId = input.dataset.partyName;
                // Update logic would go here
                updateAllPartyDropdowns();
            }

            function updateAllPartyDropdowns() {
                const partyNames = getPartyNames();
                document.querySelectorAll('.party-dropdown').forEach(select => {
                    const currentValue = select.value;
                    select.innerHTML = '<option value="">Select Parent/Guardian</option>' + 
                        partyNames.map(name => `<option value="${name}" ${name === currentValue ? 'selected' : ''}>${name}</option>`).join('');
                });
                updateCommunicationPairs();
            }

            function updatePartyDropdown(selectElement) {
                const partyNames = getPartyNames();
                const currentValue = selectElement.value;
                selectElement.innerHTML = '<option value="">Select Parent/Guardian</option>' + 
                    partyNames.map(name => `<option value="${name}" ${name === currentValue ? 'selected' : ''}>${name}</option>`).join('');
            }

            function updateCommunicationPairs() {
                const partyNames = getPartyNames();
                const partyOptions = partyNames.map(name => `<option value="${name}">${name}</option>`).join('');
                document.querySelectorAll('#communication-methods-container select').forEach(select => {
                    const currentValue = select.value;
                    select.innerHTML = partyOptions;
                    select.value = currentValue;
                });
            }

            function updateExpenseDashboard() {
                // Calculate totals and update dashboard
                let totalBudget = 0;
                let totalFinal = 0;
                
                document.querySelectorAll('.expense-budget').forEach(input => {
                    totalBudget += parseFloat(input.value) || 0;
                });
                
                document.querySelectorAll('.expense-final').forEach(input => {
                    totalFinal += parseFloat(input.value) || 0;
                });
                
                const dashboard = document.getElementById('expense-dashboard');
                if (dashboard) {
                    dashboard.innerHTML = `
                        <div class="grid grid-cols-2 gap-4">
                            <div class="text-center">
                                <div class="text-2xl font-bold text-green-400">R${totalBudget.toFixed(2)}</div>
                                <div class="text-sm text-gray-400">Total Budget</div>
                            </div>
                            <div class="text-center">
                                <div class="text-2xl font-bold text-blue-400">R${totalFinal.toFixed(2)}</div>
                                <div class="text-sm text-gray-400">Total Spent</div>
                            </div>
                        </div>`;
                }
            }

            function logEvent() {
                const container = document.getElementById('events-log-container');
                const eventHtml = `
                    <div class="event-log-item">
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div>
                                <label class="form-label">Date</label>
                                <input type="date" class="form-input">
                            </div>
                            <div>
                                <label class="form-label">Event Type</label>
                                <select class="form-select">
                                    ${generateOptions(dropdownOptions.eventType)}
                                </select>
                            </div>
                            <div>
                                <label class="form-label">Duration (hours)</label>
                                <input type="number" class="form-input" step="0.5" placeholder="0.0">
                            </div>
                            <div class="flex items-end">
                                <button class="btn-danger remove-event-btn">Remove</button>
                            </div>
                        </div>
                        <div class="mt-2">
                            <label class="form-label">Notes</label>
                            <textarea class="form-textarea" rows="2" placeholder="Event details..."></textarea>
                        </div>
                    </div>`;
                container.insertAdjacentHTML('beforeend', eventHtml);
                updateTimeDashboard();
            }

            function updateTimeDashboard() {
                // Calculate time statistics
                let totalHours = 0;
                document.querySelectorAll('#events-log-container input[step="0.5"]').forEach(input => {
                    totalHours += parseFloat(input.value) || 0;
                });
                
                const dashboard = document.getElementById('time-dashboard');
                if (dashboard) {
                    dashboard.innerHTML = `
                        <div class="text-center">
                            <div class="text-2xl font-bold text-purple-400">${totalHours.toFixed(1)} hrs</div>
                            <div class="text-sm text-gray-400">Total Logged Time</div>
                        </div>`;
                }
            }

            // Data Collection Functions
            function collectPartiesData() {
                const parties = [];
                document.querySelectorAll('.party-card').forEach(card => {
                    const nameInput = card.querySelector('.party-name');
                    if (nameInput && nameInput.value.trim()) {
                        parties.push({
                            name: nameInput.value.trim(),
                            relationship: card.querySelector('select')?.value || ''
                        });
                    }
                });
                return parties;
            }

            function collectCustodyData() {
                return {
                    schedule: document.getElementById('custody-schedule')?.value || '',
                    notes: document.getElementById('custody-notes')?.value || ''
                };
            }

            function collectExpensesData() {
                const categories = [];
                document.querySelectorAll('.expense-category').forEach(cat => {
                    const items = [];
                    cat.querySelectorAll('.expense-item').forEach(item => {
                        items.push({
                            description: item.value,
                            budget: parseFloat(item.closest('.grid').querySelector('.expense-budget').value) || 0,
                            final: parseFloat(item.closest('.grid').querySelector('.expense-final').value) || 0
                        });
                    });
                    categories.push({
                        name: cat.querySelector('.category-name').value,
                        items: items
                    });
                });
                return { categories };
            }
// --- RENDER FUNCTIONS FOR EACH BUILDER STEP ---
function renderPartiesSection(container) {
    container.innerHTML = `
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div>
                <h4 class="text-lg font-semibold mb-4">Parent/Guardian A</h4>
                <div id="a-parties-container"></div>
                <button class="btn-secondary add-guardian-btn" data-side="a">Add Guardian/Party</button>
            </div>
            <div>
                <h4 class="text-lg font-semibold mb-4">Parent/Guardian B</h4>
                <div id="b-parties-container"></div>
                <button class="btn-secondary add-guardian-btn" data-side="b">Add Guardian/Party</button>
            </div>
        </div>
        <div class="mt-8">
            <h4 class="text-lg font-semibold mb-4">Children</h4>
            <div id="children-container"></div>
            <button id="add-child-btn" class="btn-secondary">Add Child</button>
        </div>`;
    
    // Add default guardians
    addGuardian('a');
    addGuardian('b');
    addChild();
}

function renderCustodySection(container) {
    container.innerHTML = `
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div>
                <h4 class="text-lg font-semibold mb-4">Custody Schedule</h4>
                <div class="mb-4">
                    <label class="form-label">Schedule Type</label>
                    <select id="custody-schedule" class="form-select">
                        ${generateOptions(dropdownOptions.custodyDecision)}
                    </select>
                </div>
                <div class="mb-4">
                    <label class="form-label">Schedule Details</label>
                    <textarea id="custody-notes" class="form-textarea" rows="6" placeholder="Describe the custody arrangement, including weekends, holidays, and special occasions..."></textarea>
                </div>
            </div>
            <div>
                <h4 class="text-lg font-semibold mb-4">Activity Log</h4>
                <div id="time-dashboard" class="bg-gray-800 p-4 rounded-lg mb-4">
                    <div class="text-center">
                        <div class="text-2xl font-bold text-purple-400">0.0 hrs</div>
                        <div class="text-sm text-gray-400">Total Logged Time</div>
                    </div>
                </div>
                <div id="events-log-container" class="max-h-96 overflow-y-auto"></div>
                <button id="add-event-btn" class="btn-secondary">Log New Event</button>
            </div>
        </div>`;
}

function renderExpensesSection(container) {
    container.innerHTML = `
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2">
                <h4 class="text-lg font-semibold mb-4">Expense Categories</h4>
                <div id="expense-categories-container"></div>
                <button id="add-expense-category-btn" class="btn-secondary">Add Custom Category</button>
            </div>
            <div>
                <h4 class="text-lg font-semibold mb-4">Summary Dashboard</h4>
                <div id="expense-dashboard" class="bg-gray-800 p-4 rounded-lg">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="text-center">
                            <div class="text-2xl font-bold text-green-400">R0.00</div>
                            <div class="text-sm text-gray-400">Total Budget</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-blue-400">R0.00</div>
                            <div class="text-sm text-gray-400">Total Spent</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>`;
    
    // Add default categories
    dropdownOptions.expenseCategory.forEach(cat => addExpenseCategory(cat));
}

function renderCommunicationSection(container) {
    const parties = collectPartiesData();
    container.innerHTML = `
        <div class="space-y-6">
            <div>
                <h4 class="text-lg font-semibold mb-4">Communication Methods & Preferences</h4>
                <div id="communication-methods-container"></div>
                <button class="btn-secondary add-comm-method-btn">Add Communication Method</button>
            </div>
            <div>
                <h4 class="text-lg font-semibold mb-4">Communication Guidelines</h4>
                <div class="space-y-4">
                    ${dropdownOptions.communicationClassification.map(type => `
                        <div class="bg-gray-800 p-4 rounded-lg">
                            <h5 class="font-medium mb-2">${type}</h5>
                            <textarea class="form-textarea" rows="3" placeholder="Guidelines for ${type.toLowerCase()}..."></textarea>
                        </div>
                    `).join('')}
                </div>
            </div>
        </div>`;
}

function renderSummarySection(container) {
    const availableSections = state.selectedSections.filter(s => s.id !== 'summary');
    container.innerHTML = `
        <div class="space-y-6">
            <div>
                <h4 class="text-lg font-semibold mb-4">Select Sections for Final Document</h4>
                <div id="summary-section-list" class="space-y-3">
                    ${availableSections.map(section => `
                        <label class="flex items-center space-x-3 p-3 bg-gray-700 rounded-md cursor-pointer hover:bg-gray-600">
                            <input type="checkbox" value="${section.id}" class="h-5 w-5 rounded bg-gray-600 border-gray-500 text-blue-600 focus:ring-blue-500" checked>
                            <span class="text-white">${section.title}</span>
                        </label>
                    `).join('')}
                </div>
            </div>
            <div class="bg-gray-800 p-6 rounded-lg">
                <h4 class="text-lg font-semibold mb-4">Document Preview</h4>
                <p class="text-gray-400">Your parenting plan will include all selected sections above. Click "Generate Final Document" to create your comprehensive plan.</p>
            </div>
        </div>`;
}

// --- DATA COLLECTION FUNCTIONS ---
function collectPartiesData() {
    const parties = [];
    document.querySelectorAll('.party-card').forEach(card => {
        const nameInput = card.querySelector('.party-name');
        if (nameInput && nameInput.value.trim()) {
            const addresses = [];
            card.querySelectorAll('.addresses-sub-container .grid').forEach(addr => {
                const type = addr.querySelector('select')?.value;
                const address = addr.querySelector('input')?.value;
                if (type && address) addresses.push({ type, address });
            });
            
            const contacts = [];
            card.querySelectorAll('.contacts-sub-container .grid').forEach(cont => {
                const type = cont.querySelector('select')?.value;
                const contact = cont.querySelector('input')?.value;
                if (type && contact) contacts.push({ type, contact });
            });
            
            parties.push({
                name: nameInput.value.trim(),
                relationship: card.querySelector('select')?.value || '',
                addresses,
                contacts
            });
        }
    });
    return parties;
}

function collectCustodyData() {
    const events = [];
    document.querySelectorAll('.event-log-item').forEach(event => {
        const date = event.querySelector('input[type="date"]')?.value;
        const type = event.querySelector('select')?.value;
        const duration = event.querySelector('input[step="0.5"]')?.value;
        const notes = event.querySelector('textarea')?.value;
        if (date && type) {
            events.push({ date, type, duration: parseFloat(duration) || 0, notes });
        }
    });
    
    return {
        schedule: document.getElementById('custody-schedule')?.value || '',
        notes: document.getElementById('custody-notes')?.value || '',
        events
    };
}

function collectExpensesData() {
    const categories = [];
    document.querySelectorAll('.expense-category').forEach(cat => {
        const items = [];
        cat.querySelectorAll('.expense-item').forEach((item, index) => {
            const container = item.closest('.grid');
            const budget = container.querySelector('.expense-budget')?.value;
            const final = container.querySelector('.expense-final')?.value;
            const slider = container.querySelector('.contribution-slider')?.value;
            
            items.push({
                description: item.value,
                budget: parseFloat(budget) || 0,
                final: parseFloat(final) || 0,
                split: parseInt(slider) || 50
            });
        });
        
        const categoryName = cat.querySelector('.category-name')?.value;
        if (categoryName) {
            categories.push({ name: categoryName, items });
        }
    });
    return { categories };
}

function collectCommunicationData() {
    const methods = [];
    document.querySelectorAll('#communication-methods-container .grid').forEach(method => {
        const selects = method.querySelectorAll('select');
        const input = method.querySelector('input');
        if (input && input.value && selects.length >= 2) {
            methods.push({
                method: input.value,
                from: selects[0].value,
                to: selects[1].value
            });
        }
    });
    
    const guidelines = {};
    document.querySelectorAll('#communication-guidelines textarea').forEach((textarea, index) => {
        const type = dropdownOptions.communicationClassification[index];
        if (type) guidelines[type] = textarea.value;
    });
    
    return { methods, guidelines };
}

// --- DOCUMENT GENERATION FUNCTIONS ---
function generatePartiesDoc(data) {
    return `
        <h2>PARTIES, GUARDIANS & CHILDREN</h2>
        <h3>Parties</h3>
        ${data.map(party => `
            <p><strong>${party.name}</strong> - ${party.relationship}</p>
            ${party.addresses.length ? `<p>Addresses: ${party.addresses.map(a => `${a.type}: ${a.address}`).join('; ')}</p>` : ''}
            ${party.contacts.length ? `<p>Contacts: ${party.contacts.map(c => `${c.type}: ${c.contact}`).join('; ')}</p>` : ''}
        `).join('<br>')}
    `;
}

function generateCustodyDoc(data) {
    return `
        <h2>CUSTODY & ACTIVITY SCHEDULE</h2>
        <p><strong>Schedule Type:</strong> ${data.schedule}</p>
        <p><strong>Details:</strong> ${data.notes}</p>
        ${data.events && data.events.length ? `
            <h3>Activity Log</h3>
            ${data.events.map(event => `
                <p>${event.date} - ${event.type} (${event.duration}hrs): ${event.notes}</p>
            `).join('')}
        ` : ''}
    `;
}

function generateExpensesDoc(data) {
    return `
        <h2>EXPENSE & BENEFIT TRACKER</h2>
        ${data.categories.map(cat => `
            <h3>${cat.name}</h3>
            ${cat.items.map(item => `
                <p>${item.description}: Budget R${item.budget.toFixed(2)}, Final R${item.final.toFixed(2)} (Split: ${item.split}/${100-item.split})</p>
            `).join('')}
        `).join('')}
    `;
}

function generateCommunicationDoc(data) {
    return `
        <h2>COMMUNICATION PLAN</h2>
        <h3>Communication Methods</h3>
        ${data.methods.map(method => `
            <p>${method.method}: ${method.from} → ${method.to}</p>
        `).join('')}
        <h3>Guidelines</h3>
        ${Object.entries(data.guidelines).map(([type, guideline]) => `
            <p><strong>${type}:</strong> ${guideline}</p>
        `).join('')}
    `;
}

function generateDocument(sectionIds) {
    let fullDocument = '<html><head><title>Parenting Plan</title><style>body{font-family:Arial,sans-serif;margin:40px;}</style></head><body>';
    fullDocument += '<h1>PARENTING PLAN</h1>';
    fullDocument += `<p><em>Generated on ${new Date().toLocaleDateString()}</em></p><hr>`;
    
    sectionIds.forEach(sectionId => {
        const section = state.allSections.find(s => s.id === sectionId);
        if (section && section.collect && section.generate) {
            const data = section.collect();
            fullDocument += section.generate(data);
            fullDocument += '<hr>';
        }
    });
    
    fullDocument += '</body></html>';
    
    const blob = new Blob([fullDocument], { type: 'text/html' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'parenting-plan.html';
    a.click();
    URL.revokeObjectURL(url);
}

// --- MISSING DYNAMIC UI FUNCTIONS ---
function addGuardian(side) {
    const container = document.getElementById(`${side}-parties-container`);
    const guardianId = `guardian-${Date.now()}`;
    const guardianHtml = `
        <div class="party-card bg-gray-800 p-4 rounded-lg mb-4">
            <div class="flex justify-between items-center mb-4">
                <h4 class="font-semibold">Guardian/Party</h4>
                <button class="btn-danger remove-guardian-btn">Remove</button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="form-label">Full Name</label>
                    <input type="text" class="form-input party-name" data-party-name="${guardianId}">
                </div>
                <div>
                    <label class="form-label">Relationship to Child</label>
                    <select class="form-select">
                        ${generateOptions(dropdownOptions.relationship)}
                    </select>
                </div>
            </div>
            <div class="addresses-sub-container mb-4">
                <h5 class="font-medium mb-2">Addresses</h5>
            </div>
            <button class="btn-secondary add-address-btn mb-4">Add Address</button>
            <div class="contacts-sub-container mb-4">
                <h5 class="font-medium mb-2">Contact Information</h5>
            </div>
            <button class="btn-secondary add-contact-btn">Add Contact</button>
        </div>`;
    container.insertAdjacentHTML('beforeend', guardianHtml);
    updateAllPartyDropdowns();
}

function addAddress(container) {
    const addressHtml = `
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-2 p-3 bg-gray-700 rounded">
            <div>
                <label class="form-label">Address Type</label>
                <select class="form-select">
                    ${generateOptions(dropdownOptions.addressType)}
                </select>
            </div>
            <div class="md:col-span-2">
                <label class="form-label">Full Address</label>
                <div class="flex gap-2">
                    <input type="text" class="form-input" placeholder="Street, City, Province, Postal Code">
                    <button class="btn-danger remove-sub-item-btn">×</button>
                </div>
            </div>
        </div>`;
    container.insertAdjacentHTML('beforeend', addressHtml);
}

function addContact(container) {
    const contactHtml = `
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-2 p-3 bg-gray-700 rounded">
            <div>
                <label class="form-label">Contact Type</label>
                <select class="form-select">
                    ${generateOptions(dropdownOptions.contactType)}
                </select>
            </div>
            <div class="md:col-span-2">
                <label class="form-label">Contact Information</label>
                <div class="flex gap-2">
                    <input type="text" class="form-input" placeholder="Phone number, email, etc.">
                    <button class="btn-danger remove-sub-item-btn">×</button>
                </div>
            </div>
        </div>`;
    container.insertAdjacentHTML('beforeend', contactHtml);
}

function addChild() {
    const container = document.getElementById('children-container');
    const childHtml = `
        <div class="party-card bg-gray-800 p-4 rounded-lg mb-4">
            <div class="flex justify-between items-center mb-4">
                <h4 class="font-semibold">Child</h4>
                <button class="btn-danger remove-sub-item-btn">Remove</button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="form-label">Full Name</label>
                    <input type="text" class="form-input">
                </div>
                <div>
                    <label class="form-label">Date of Birth</label>
                    <input type="date" class="form-input">
                </div>
                <div>
                    <label class="form-label">Primary Residence</label>
                    <select class="form-select party-dropdown">
                        <option value="">Select Parent/Guardian</option>
                    </select>
                </div>
            </div>
        </div>`;
    container.insertAdjacentHTML('beforeend', childHtml);
    updateAllPartyDropdowns();
}

function addExpenseCategory(name = '') {
    const container = document.getElementById('expense-categories-container');
    const categoryId = `category-${Date.now()}`;
    const categoryHtml = `
        <div class="expense-category bg-gray-800 p-4 rounded-lg mb-4" data-category-id="${categoryId}">
            <div class="flex justify-between items-center mb-4">
                <input type="text" class="form-input category-name" value="${name}" placeholder="Category Name">
                <button class="btn-danger remove-category-btn">Remove Category</button>
            </div>
            <div class="expense-items-container mb-4"></div>
            <button class="btn-secondary add-expense-item-btn">Add Expense Item</button>
        </div>`;
    container.insertAdjacentHTML('beforeend', categoryHtml);
    updateExpenseDashboard();
}

function addExpenseItem(container) {
    const partyNames = getPartyNames();
    const itemHtml = `
        <div class="grid grid-cols-1 md:grid-cols-6 gap-4 mb-2 p-3 bg-gray-700 rounded">
            <div>
                <label class="form-label">Item</label>
                <input type="text" class="form-input expense-item" placeholder="Expense description">
            </div>
            <div>
                <label class="form-label">Budget</label>
                <input type="number" class="form-input expense-budget" placeholder="0.00" step="0.01">
            </div>
            <div>
                <label class="form-label">Final Cost</label>
                <input type="number" class="form-input expense-final" placeholder="0.00" step="0.01">
            </div>
            <div class="md:col-span-2">
                <label class="form-label">Contribution Split</label>
                <div class="flex items-center space-x-2">
                    <span class="text-xs percent-a">50</span>%
                    <input type="range" class="contribution-slider flex-1" min="0" max="100" value="50">
                    <span class="text-xs percent-b">50</span>%
                </div>
                <div class="text-xs text-gray-400 mt-1">${partyNames[0] || 'Parent A'} - ${partyNames[1] || 'Parent B'}</div>
            </div>
            <div class="flex items-end">
                <button class="btn-danger remove-sub-item-btn">Remove</button>
            </div>
        </div>`;
    container.insertAdjacentHTML('beforeend', itemHtml);
    updateExpenseDashboard();
}

function addCommunicationMethod(container, parties) {
    const partyOptions = parties.map(p => `<option value="${p.name}">${p.name}</option>`).join('');
    const methodHtml = `
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-2 p-3 bg-gray-700 rounded">
            <div>
                <label class="form-label">Method</label>
                <input type="text" class="form-input" placeholder="e.g., WhatsApp, Email">
            </div>
            <div>
                <label class="form-label">From</label>
                <select class="form-select">${partyOptions}</select>
            </div>
            <div>
                <label class="form-label">To</label>
                <select class="form-select">${partyOptions}</select>
            </div>
            <div class="flex items-end">
                <button class="btn-danger remove-sub-item-btn">Remove</button>
            </div>
        </div>`;
    container.insertAdjacentHTML('beforeend', methodHtml);
}

function updatePartyNames(e) {
    const input = e.target;
    const partyId = input.dataset.partyName;
    updateAllPartyDropdowns();
}

function updateAllPartyDropdowns() {
    const partyNames = getPartyNames();
    document.querySelectorAll('.party-dropdown').forEach(select => {
        const currentValue = select.value;
        select.innerHTML = '<option value="">Select Parent/Guardian</option>' + 
            partyNames.map(name => `<option value="${name}" ${name === currentValue ? 'selected' : ''}>${name}</option>`).join('');
    });
    updateCommunicationPairs();
}

function updatePartyDropdown(selectElement) {
    const partyNames = getPartyNames();
    const currentValue = selectElement.value;
    selectElement.innerHTML = '<option value="">Select Parent/Guardian</option>' + 
        partyNames.map(name => `<option value="${name}" ${name === currentValue ? 'selected' : ''}>${name}</option>`).join('');
}

function updateCommunicationPairs() {
    const partyNames = getPartyNames();
    const partyOptions = partyNames.map(name => `<option value="${name}">${name}</option>`).join('');
    document.querySelectorAll('#communication-methods-container select').forEach(select => {
        const currentValue = select.value;
        select.innerHTML = partyOptions;
        select.value = currentValue;
    });
}

function updateExpenseDashboard() {
    let totalBudget = 0;
    let totalFinal = 0;
    
    document.querySelectorAll('.expense-budget').forEach(input => {
        totalBudget += parseFloat(input.value) || 0;
    });
    
    document.querySelectorAll('.expense-final').forEach(input => {
        totalFinal += parseFloat(input.value) || 0;
    });
    
    const dashboard = document.getElementById('expense-dashboard');
    if (dashboard) {
        dashboard.innerHTML = `
            <div class="grid grid-cols-2 gap-4">
                <div class="text-center">
                    <div class="text-2xl font-bold text-green-400">R${totalBudget.toFixed(2)}</div>
                    <div class="text-sm text-gray-400">Total Budget</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-blue-400">R${totalFinal.toFixed(2)}</div>
                    <div class="text-sm text-gray-400">Total Spent</div>
                </div>
            </div>`;
    }
}

function logEvent() {
    const container = document.getElementById('events-log-container');
    const eventHtml = `
        <div class="event-log-item bg-gray-800 p-4 rounded-lg mb-4">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label class="form-label">Date</label>
                    <input type="date" class="form-input">
                </div>
                <div>
                    <label class="form-label">Event Type</label>
                    <select class="form-select">
                        ${generateOptions(dropdownOptions.eventType)}
                    </select>
                </div>
                <div>
                    <label class="form-label">Duration (hours)</label>
                    <input type="number" class="form-input" step="0.5" placeholder="0.0">
                </div>
                <div class="flex items-end">
                    <button class="btn-danger remove-event-btn">Remove</button>
                </div>
            </div>
            <div class="mt-2">
                <label class="form-label">Notes</label>
                <textarea class="form-textarea" rows="2" placeholder="Event details..."></textarea>
            </div>
        </div>`;
    container.insertAdjacentHTML('beforeend', eventHtml);
    updateTimeDashboard();
}

function updateTimeDashboard() {
    let totalHours = 0;
    document.querySelectorAll('#events-log-container input[step="0.5"]').forEach(input => {
        totalHours += parseFloat(input.value) || 0;
    });
    
    const dashboard = document.getElementById('time-dashboard');
    if (dashboard) {
        dashboard.innerHTML = `
            <div class="text-center">
                <div class="text-2xl font-bold text-purple-400">${totalHours.toFixed(1)} hrs</div>
                <div class="text-sm text-gray-400">Total Logged Time</div>
            </div>`;
    }
}

function setDynamicBackground() {
    const backgrounds = [
        'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
        'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
        'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
        'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)'
    ];
    const randomBg = backgrounds[Math.floor(Math.random() * backgrounds.length)];
    containers.bg.style.background = randomBg;
}
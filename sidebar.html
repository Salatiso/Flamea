<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flamea Sidebar Component</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Slab:wght@700&family=Open+Sans:wght@400;600;700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Styles from your original sidebar.html, preserved exactly. */
        .sidebar-link { transition: background-color 0.2s, color 0.2s; }
        .sidebar-link:hover, .sidebar-link-main:hover { background-color: #1f2937; color: white; }
        .submenu-container { display: none; }
        [data-menu-item].active > .submenu-toggle .fa-chevron-down,
        [data-menu-item].active > button .fa-chevron-down { transform: rotate(180deg); }

        /* --- NEW Podcast Player Styles (Self-Contained) --- */
        #podcast-player-container { background-color: #111827; color: #d1d5db; }
        #podcast-playlist { max-height: 200px; overflow-y: auto; border-top: 1px solid #374151; }
        .podcast-playlist-item { cursor: pointer; transition: background-color 0.2s; border-left: 3px solid transparent; }
        .podcast-playlist-item:hover { background-color: #374151; }
        .podcast-playlist-item.active { background-color: rgba(74, 222, 128, 0.1); border-left-color: #4ade80; }
        #podcast-progress-container { background-color: #4b5563; cursor: pointer; }
        #podcast-progress-bar { background-color: #4ade80; }
        #podcast-playlist::-webkit-scrollbar { width: 5px; }
        #podcast-playlist::-webkit-scrollbar-track { background: #1f2937; }
        #podcast-playlist::-webkit-scrollbar-thumb { background: #4ade80; border-radius: 3px; }

        /* --- NEW Chatbot Modal Styles (Self-Contained) --- */
        #chatbot-modal-overlay { background-color: rgba(17, 24, 39, 0.5); backdrop-filter: blur(8px); }
        .chat-container { background-color: #1f2937; border: 1px solid #374151; }
        #chat-messages { scrollbar-width: thin; scrollbar-color: #4ade80 #1f2937; }
        #chat-messages::-webkit-scrollbar { width: 6px; }
        #chat-messages::-webkit-scrollbar-track { background: #1f2937; }
        #chat-messages::-webkit-scrollbar-thumb { background-color: #4ade80; border-radius: 3px; }
        .message.user { background-color: #4ade80; color: #111827; align-self: flex-end; border-radius: 1.25rem 1.25rem 0.25rem 1.25rem; }
        .message.sazi { background-color: #374151; color: #e5e7eb; align-self: flex-start; border-radius: 1.25rem 1.25rem 1.25rem 0.25rem; }
        #chat-input { background-color: #374151; color: #e5e7eb; caret-color: #4ade80; }
        #chat-input:focus { outline: none; border-color: #4ade80; box-shadow: 0 0 0 2px rgba(74, 222, 128, 0.4); }
        #send-btn { background-color: #4ade80; color: #1f2937; }
        .loader { width: 8px; height: 8px; border-radius: 50%; display: block; margin: auto; position: relative; color: #a3a3a3; box-sizing: border-box; animation: animloader 1s linear infinite; }
        @keyframes animloader { 0% { box-shadow: -16px 0, 16px 0; } 25% { box-shadow: -16px 0, 16px 0; } 50% { box-shadow: -16px -8px, 16px 8px; } 75% { box-shadow: -16px 8px, 16px -8px; } 100% { box-shadow: -16px 0, 16px 0; } }
    </style>
</head>
<body class="bg-gray-800">

<aside class="p-6 flex flex-col justify-between h-full bg-gray-900 text-gray-300" style="width: 288px;">
    <!-- Top Section: Logo & Navigation (Preserved from your original file) -->
    <div class="sidebar-top">
        <div class="mb-12 flex justify-center">
            <a href="desktop-index.html" class="flamea-logo dark">
                <svg width="160" height="48" viewBox="0 0 200 60" xmlns="http://www.w3.org/2000/svg" aria-label="Flamea Home">
                    <text class="logo-text" x="0" y="45" font-family="Inter, sans-serif" font-size="50" font-weight="400" fill="white">Flame</text>
                    <g transform="translate(135, 0)"><path d="M18 5 L 0 50 L 8 50 C 12 42, 24 42, 28 50 L 36 50 Z" fill="#4ade80"></path></g>
                    <line x1="0" y1="58" x2="171" y2="58" stroke="#4ade80" stroke-width="2.5" stroke-linecap="round"></line>
                </svg>
            </a>
        </div>
        
        <nav id="main-nav" class="flex flex-col space-y-2">
            <!-- All original nav items preserved -->
            <a href="desktop-index.html" class="sidebar-link flex items-center p-3 rounded-lg"><i class="fas fa-home w-6 text-center mr-4"></i> Home</a>
            <a href="about.html" class="sidebar-link flex items-center p-3 rounded-lg"><i class="fas fa-bullseye w-6 text-center mr-4"></i> About</a>
            <div class="relative" data-menu-item="tools-hub">
                <div class="flex items-center rounded-lg hover:bg-gray-800">
                    <a href="tools.html" class="sidebar-link-main flex-grow flex items-center p-3"><i class="fas fa-tools w-6 text-center mr-4"></i> Tools Hub</a>
                    <button class="submenu-toggle p-3 pr-4 text-gray-400 hover:text-white"><i class="fas fa-chevron-down transition-transform duration-300"></i></button>
                </div>
                <div class="submenu-container pl-11 py-2 ml-2 border-l-2 border-gray-700 bg-gray-800/30" style="display: none;">
                    <a href="forms.html" class="sidebar-link flex items-center p-2 rounded-lg text-sm"><i class="fas fa-file-alt w-6 text-center mr-3 text-blue-400"></i> Forms & Templates</a>
                    <a href="customs.html" class="sidebar-link flex items-center p-2 rounded-lg text-sm"><i class="fas fa-globe w-6 text-center mr-3 text-green-400"></i> Traditional Customs</a>
                    <a href="games.html" class="sidebar-link flex items-center p-2 rounded-lg text-sm"><i class="fas fa-gamepad w-6 text-center mr-3 text-purple-400"></i> Interactive Games</a>
                    <a href="current-affairs.html" class="sidebar-link flex items-center p-2 rounded-lg text-sm"><i class="fas fa-newspaper w-6 text-center mr-3 text-yellow-400"></i> Current Affairs</a>
                    <a href="legalhelp.html" class="sidebar-link flex items-center p-2 rounded-lg text-sm"><i class="fas fa-gavel w-6 text-center mr-3 text-red-400"></i> LegalHelp</a>
                </div>
            </div>
            <a href="training.html" class="sidebar-link flex items-center p-3 rounded-lg"><i class="fas fa-book-reader w-6 text-center mr-4"></i> Training Hub</a>
            <a href="locator.html" class="sidebar-link flex items-center p-3 rounded-lg"><i class="fas fa-users w-6 text-center mr-4"></i> Resource Hub</a>
            <a href="community.html" class="sidebar-link flex items-center p-3 rounded-lg"><i class="fas fa-users w-6 text-center mr-4"></i> Community</a>
            <div class="border-t border-gray-700 my-4"></div>
            <a href="parenting-plan.html" class="sidebar-link flex items-center p-3 rounded-lg"><i class="fas fa-clipboard-check w-6 text-center mr-4 text-teal-400"></i> Parenting Plan Builder</a>
            <a href="assessment.html" class="sidebar-link flex items-center p-3 rounded-lg"><i class="fas fa-clipboard-check w-6 text-center mr-4 text-teal-400"></i> Needs Assessment</a>
            <div class="border-t border-gray-700 my-4"></div>
            <a href="publications.html" class="sidebar-link flex items-center p-3 rounded-lg"><i class="fas fa-book w-6 text-center mr-4 text-blue-400"></i> Publications</a>
            
            <!-- FIXED Podcast Player Integration -->
            <div class="relative" data-menu-item="podcast-player">
                <button class="submenu-toggle flex items-center p-3 rounded-lg w-full text-left text-gray-300 hover:bg-gray-800 hover:text-white">
                    <i class="fas fa-podcast w-6 text-center mr-4 text-yellow-400"></i>
                    <span class="flex-grow">Podcast</span>
                    <i class="fas fa-chevron-down text-xs transition-transform duration-300"></i>
                </button>
                <div id="podcast-player-container" class="submenu-container text-sm p-3 bg-gray-800/30">
                    <div id="podcast-loader" class="text-center p-4"><i class="fas fa-spinner fa-spin text-yellow-400"></i><p class="text-xs mt-2">Loading Player...</p></div>
                </div>
            </div>

            <!-- FIXED Chatbot Button -->
            <button id="isazi-chatbot-trigger" class="sidebar-link flex items-center p-3 rounded-lg w-full text-left"><i class="fas fa-robot w-6 text-center mr-4 text-purple-400"></i> iSazi: The Fatherhood Guide</button>
        </nav>
    </div>
    
    <!-- Bottom Section (RESTORED from your original file) -->
    <div class="sidebar-bottom text-center">
        <div class="mb-4" data-menu-item="join-movement">
            <button class="submenu-toggle flex items-center p-3 rounded-lg w-full text-left text-gray-300 hover:bg-gray-800 hover:text-white">
                <i class="fas fa-hands-helping w-6 text-center mr-4 text-yellow-400"></i>
                <span class="flex-grow font-semibold">Join the Movement</span>
                <i class="fas fa-chevron-down text-xs transition-transform duration-300"></i>
            </button>
            <div class="submenu-container text-left text-sm p-4 bg-gray-800 rounded-b-lg" style="display: none;">
                <p class="text-gray-400 mb-4">Flamea is built by the community, for the community. See how you can contribute.</p>
                <a href="join-the-movement.html" class="font-bold text-yellow-400 hover:underline">Learn More →</a>
            </div>
        </div>
        <div id="sidebar-auth-links" class="mb-4">
            <!-- Auth state populated by auth.js -->
        </div>
        <div class="text-xs text-gray-500 leading-relaxed">
            <span>© 2025 Flamea.Org</span><br>
            <span>Powered by <a href="https://salatiso.com/" target="_blank" class="hover:underline text-gray-400">Salatiso</a></span>
        </div>
    </div>
</aside>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- 1. PRESERVED ACCORDION LOGIC ---
    // This logic handles all expandable menu items, including the restored "Join the Movement"
    const menuItems = document.querySelectorAll('[data-menu-item]');
    menuItems.forEach(item => {
        const toggle = item.querySelector('.submenu-toggle');
        const submenu = item.querySelector('.submenu-container');
        if (toggle && submenu) {
            toggle.addEventListener('click', (e) => {
                e.stopPropagation();
                const wasActive = item.classList.contains('active');
                menuItems.forEach(otherItem => {
                    if (otherItem !== item) {
                        otherItem.classList.remove('active');
                        otherItem.querySelector('.submenu-container').style.display = 'none';
                    }
                });
                if (wasActive) {
                    item.classList.remove('active');
                    submenu.style.display = 'none';
                } else {
                    item.classList.add('active');
                    submenu.style.display = 'block';
                }
            });
        }
    });

    // --- 2. FIXED PODCAST PLAYER LOGIC ---
    const initPodcastPlayer = () => {
        let audioPlayer = document.getElementById('flamea-audio-player');
        if (!audioPlayer) {
            audioPlayer = document.createElement('audio');
            audioPlayer.id = 'flamea-audio-player';
            audioPlayer.crossOrigin = 'anonymous';
            document.body.appendChild(audioPlayer);
        }
        
        const playerContainer = document.getElementById('podcast-player-container');
        if (!playerContainer) return;

        let episodes = [];
        let currentEpisodeIndex = 0;
        let isPlaying = false;
        
        const RSS_URL = `https://api.allorigins.win/raw?url=${encodeURIComponent('https://anchor.fm/s/10357aacc/podcast/rss')}`;

        fetch(RSS_URL)
            .then(response => response.ok ? response.text() : Promise.reject('Network failed'))
            .then(str => new window.DOMParser().parseFromString(str, "text/xml"))
            .then(data => {
                const items = data.querySelectorAll("item");
                items.forEach(item => {
                    episodes.push({
                        title: item.querySelector("title").textContent,
                        audioSrc: item.querySelector("enclosure")?.getAttribute('url'),
                        artworkUrl: item.querySelector("image")?.getAttribute('href') || 'https://placehold.co/100x100/111827/4ade80?text=F'
                    });
                });
                renderPlayer();
                loadEpisode(0);
            })
            .catch(err => {
                playerContainer.innerHTML = `<p class="p-2 text-xs text-center text-red-400">Could not load podcast feed.</p>`;
            });

        function renderPlayer() {
            playerContainer.innerHTML = `
                <div class="flex items-center gap-3 mb-3">
                    <img id="podcast-art" class="w-12 h-12 rounded-md object-cover flex-shrink-0" src="">
                    <div class="flex-grow overflow-hidden"><p id="podcast-title" class="font-semibold text-white truncate text-sm"></p></div>
                </div>
                <div id="podcast-progress-container" class="h-1.5 rounded-full w-full bg-gray-600 mb-2 cursor-pointer"><div id="podcast-progress-bar" class="h-full rounded-full" style="width: 0%;"></div></div>
                <div class="flex justify-between text-xs text-gray-400 mb-2 px-1">
                    <span id="podcast-current-time">0:00</span><span id="podcast-total-duration">0:00</span>
                </div>
                <div class="flex items-center justify-around">
                    <button id="podcast-prev-btn" class="p-2 hover:text-white"><i class="fas fa-backward-step"></i></button>
                    <button id="podcast-play-pause-btn" class="p-2 text-xl hover:text-white"><i class="fas fa-play"></i></button>
                    <button id="podcast-next-btn" class="p-2 hover:text-white"><i class="fas fa-forward-step"></i></button>
                </div>
                <div id="podcast-playlist" class="mt-3"></div>`;
            
            const playlistEl = document.getElementById('podcast-playlist');
            episodes.forEach((ep, index) => {
                const itemEl = document.createElement('div');
                itemEl.className = 'podcast-playlist-item p-2 flex items-center gap-2 rounded-md';
                itemEl.innerHTML = `<img src="${ep.artworkUrl}" class="w-8 h-8 rounded-sm object-cover flex-shrink-0"><p class="flex-grow truncate text-xs">${ep.title}</p>`;
                itemEl.addEventListener('click', () => { currentEpisodeIndex = index; loadEpisode(index); playEpisode(); });
                playlistEl.appendChild(itemEl);
            });
            
            document.getElementById('podcast-play-pause-btn').addEventListener('click', () => isPlaying ? pauseEpisode() : playEpisode());
            document.getElementById('podcast-next-btn').addEventListener('click', playNext);
            document.getElementById('podcast-prev-btn').addEventListener('click', playPrev);
            document.getElementById('podcast-progress-container').addEventListener('click', setProgress);
        }

        function loadEpisode(index) {
            const episode = episodes[index];
            if (!episode || !episode.audioSrc) return;
            document.getElementById('podcast-art').src = episode.artworkUrl;
            document.getElementById('podcast-title').textContent = episode.title;
            audioPlayer.src = `https://api.allorigins.win/raw?url=${encodeURIComponent(episode.audioSrc)}`;
            document.querySelectorAll('.podcast-playlist-item').forEach((item, idx) => item.classList.toggle('active', idx === index));
        }

        const playEpisode = () => audioPlayer.play().then(() => { isPlaying = true; document.getElementById('podcast-play-pause-btn').innerHTML = '<i class="fas fa-pause"></i>'; }).catch(e => console.error("Playback Error:", e));
        const pauseEpisode = () => { audioPlayer.pause(); isPlaying = false; document.getElementById('podcast-play-pause-btn').innerHTML = '<i class="fas fa-play"></i>'; };
        const playNext = () => { currentEpisodeIndex = (currentEpisodeIndex + 1) % episodes.length; loadEpisode(currentEpisodeIndex); playEpisode(); };
        const playPrev = () => { currentEpisodeIndex = (currentEpisodeIndex - 1 + episodes.length) % episodes.length; loadEpisode(currentEpisodeIndex); playEpisode(); };
        const setProgress = e => { if(audioPlayer.duration) audioPlayer.currentTime = (e.offsetX / e.currentTarget.clientWidth) * audioPlayer.duration; };
        const formatTime = s => isNaN(s) ? '0:00' : `${Math.floor(s/60)}:${('0'+Math.floor(s%60)).slice(-2)}`;
        
        audioPlayer.addEventListener('timeupdate', () => { if(audioPlayer.duration) { document.getElementById('podcast-progress-bar').style.width = `${(audioPlayer.currentTime/audioPlayer.duration)*100}%`; document.getElementById('podcast-current-time').textContent = formatTime(audioPlayer.currentTime); }});
        audioPlayer.addEventListener('loadedmetadata', () => { if(audioPlayer.duration) { document.getElementById('podcast-total-duration').textContent = formatTime(audioPlayer.duration); }});
        audioPlayer.addEventListener('ended', playNext);
    };
    initPodcastPlayer();

    // --- 3. FIXED CHATBOT MODAL LOGIC ---
    const initChatbot = () => {
        const trigger = document.getElementById('isazi-chatbot-trigger');
        if (!trigger) return;

        const chatbotModalHTML = `
            <div id="chatbot-modal-overlay" class="fixed inset-0 z-50 flex items-center justify-center p-4">
                <div class="chat-container w-full max-w-2xl h-[80vh] max-h-[700px] rounded-2xl shadow-2xl flex flex-col">
                    <div class="flex items-center justify-between p-4 border-b border-gray-600">
                        <div class="flex items-center gap-3"><i class="fas fa-robot text-2xl text-purple-400"></i><div><h2 class="text-xl font-bold text-white">iSazi: The Fatherhood Guide</h2><p class="text-sm text-gray-400">Your AI companion for guidance.</p></div></div>
                        <button id="close-chatbot-btn" class="text-gray-400 hover:text-white text-2xl">&times;</button>
                    </div>
                    <div id="chat-messages" class="flex-grow p-4 overflow-y-auto flex flex-col gap-4">
                        <div class="message sazi p-3"><p>Molweni, I am iSazi. How can I help you on your fatherhood journey today?</p></div>
                    </div>
                    <div class="p-4 border-t border-gray-600">
                        <div class="flex items-center gap-3">
                            <input type="text" id="chat-input" class="w-full p-3 rounded-lg border border-gray-600 focus:ring-0" placeholder="Ask iSazi a question...">
                            <button id="send-btn" class="p-3 rounded-lg font-bold"><i class="fas fa-paper-plane"></i></button>
                        </div>
                    </div>
                </div>
            </div>`;

        trigger.addEventListener('click', () => {
            if (document.getElementById('chatbot-modal-overlay')) return;
            const modalFragment = document.createRange().createContextualFragment(chatbotModalHTML);
            document.body.appendChild(modalFragment);
            attachChatbotLogic();
        });

        const attachChatbotLogic = () => {
            const closeBtn = document.getElementById('close-chatbot-btn');
            const chatInput = document.getElementById('chat-input');
            const sendBtn = document.getElementById('send-btn');
            const chatMessages = document.getElementById('chat-messages');
            
            const addMessage = (sender, text) => {
                const messageEl = document.createElement('div');
                messageEl.className = `message ${sender} p-3`;
                messageEl.innerHTML = `<p>${text.replace(/\n/g, '<br>')}</p>`;
                chatMessages.appendChild(messageEl);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            };

            const handleSend = async () => {
                const userInput = chatInput.value.trim();
                if (userInput === "") return;
                addMessage('user', userInput);
                chatInput.value = "";
                
                const typingEl = document.createElement('div');
                typingEl.id = 'typing-indicator';
                typingEl.className = 'message sazi p-4';
                typingEl.innerHTML = '<span class="loader"></span>';
                chatMessages.appendChild(typingEl);
                chatMessages.scrollTop = chatMessages.scrollHeight;
                
                try {
                    const apiKey = ""; // Handled by environment
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                    const payload = { contents: [{ role: "user", parts: [{ text: `You are iSazi, a wise Xhosa elder ('Khulu') AI guide for South African fathers. Your focus is on legal rights (Children's Act), co-parenting, and cultural customs. Your tone is empowering and supportive. Keep answers concise. User question: ${userInput}` }] }] };
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) throw new Error('API request failed');
                    const result = await response.json();
                    document.getElementById('typing-indicator')?.remove();
                    const botResponse = result.candidates[0].content.parts[0].text;
                    addMessage('sazi', botResponse);
                } catch (error) {
                    document.getElementById('typing-indicator')?.remove();
                    addMessage('sazi', "Apologies, I'm having trouble connecting right now. Please try again later.");
                }
            };
            
            closeBtn.addEventListener('click', () => document.getElementById('chatbot-modal-overlay')?.remove());
            sendBtn.addEventListener('click', handleSend);
            chatInput.addEventListener('keypress', e => { if (e.key === 'Enter') handleSend(); });
        };
    };
    initChatbot();
});
</script>

</body>
</html>
